"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.loadTheme = loadTheme;
exports.default = _default;

var _lodash = _interopRequireDefault(require("lodash"));

var _fs = _interopRequireDefault(require("fs"));

var _path = _interopRequireDefault(require("path"));

var _express = _interopRequireDefault(require("express"));

var _utils = require("../../lib/utils");

var _search = _interopRequireDefault(require("../../lib/search"));

var _constants = require("../../lib/constants");

var _pluginLoader = _interopRequireDefault(require("../../lib/plugin-loader"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * @prettier
 */
const {
  setSecurityWebHeaders
} = require('../middleware');

const pkgJSON = require('../../../package.json');

function loadTheme(config) {
  if (_lodash.default.isNil(config.theme) === false) {
    return _lodash.default.head((0, _pluginLoader.default)(config, config.theme, {}, function (plugin) {
      return _lodash.default.isString(plugin);
    }, 'verdaccio-theme'));
  }
}

const sendFileCallback = next => err => {
  if (!err) {
    return;
  }

  if (err.status === _constants.HTTP_STATUS.NOT_FOUND) {
    next();
  } else {
    next(err);
  }
};

function _default(config, auth, storage) {
  _search.default.configureStorage(storage);
  /* eslint new-cap:off */


  const router = _express.default.Router();

  router.use(auth.webUIJWTmiddleware());
  router.use(setSecurityWebHeaders);

  const themePath = loadTheme(config) || require('@verdaccio/ui-theme')();

  const indexTemplate = _path.default.join(themePath, 'index.html');

  const template = _fs.default.readFileSync(indexTemplate).toString(); // Logo


  let logoURI = _lodash.default.get(config, 'web.logo') ? config.web.logo : '';

  if (logoURI && !(0, _utils.isHTTPProtocol)(logoURI)) {
    // URI related to a local file
    // Note: `path.join` will break on Windows, because it transforms `/` to `\`
    // Use POSIX version `path.posix.join` instead.
    logoURI = _path.default.posix.join('/-/static/', _path.default.basename(logoURI));
    router.get(logoURI, function (req, res, next) {
      res.sendFile(_path.default.resolve(config.web.logo), sendFileCallback(next));
    });
  } // Static


  router.get('/-/static/*', function (req, res, next) {
    const filename = req.params[0];
    const file = `${themePath}/${filename}`;
    res.sendFile(file, sendFileCallback(next));
  });

  function renderHTML(req, res) {
    const protocol = (0, _utils.getWebProtocol)(req.get(_constants.HEADERS.FORWARDED_PROTO), req.protocol);
    const host = req.get('host');
    const {
      url_prefix
    } = config;
    const uri = `${protocol}://${host}`;
    const base = (0, _utils.combineBaseUrl)(protocol, host, url_prefix);
    const primaryColor = _lodash.default.get(config, 'web.primary_color') ? config.web.primary_color : '';
    const title = _lodash.default.get(config, 'web.title') ? config.web.title : _constants.WEB_TITLE;
    const scope = _lodash.default.get(config, 'web.scope') ? config.web.scope : '';
    const options = {
      uri,
      protocol,
      host,
      url_prefix,
      base,
      primaryColor,
      title,
      scope
    };
    const webPage = template.replace(/ToReplaceByVerdaccioUI/g, JSON.stringify(options)).replace(/ToReplaceByVerdaccio/g, base).replace(/ToReplaceByPrefix/g, url_prefix).replace(/ToReplaceByVersion/g, pkgJSON.version).replace(/ToReplaceByTitle/g, title).replace(/ToReplaceByLogo/g, logoURI).replace(/ToReplaceByPrimaryColor/g, primaryColor).replace(/ToReplaceByScope/g, scope);
    res.setHeader('Content-Type', _constants.HEADERS.TEXT_HTML);
    res.send(webPage);
  }

  router.get('/-/web/:section/*', function (req, res) {
    renderHTML(req, res);
  });
  router.get('/', function (req, res) {
    renderHTML(req, res);
  });
  return router;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9hcGkvd2ViL2luZGV4LnRzIl0sIm5hbWVzIjpbInNldFNlY3VyaXR5V2ViSGVhZGVycyIsInJlcXVpcmUiLCJwa2dKU09OIiwibG9hZFRoZW1lIiwiY29uZmlnIiwiXyIsImlzTmlsIiwidGhlbWUiLCJoZWFkIiwicGx1Z2luIiwiaXNTdHJpbmciLCJzZW5kRmlsZUNhbGxiYWNrIiwibmV4dCIsImVyciIsInN0YXR1cyIsIkhUVFBfU1RBVFVTIiwiTk9UX0ZPVU5EIiwiYXV0aCIsInN0b3JhZ2UiLCJTZWFyY2giLCJjb25maWd1cmVTdG9yYWdlIiwicm91dGVyIiwiZXhwcmVzcyIsIlJvdXRlciIsInVzZSIsIndlYlVJSldUbWlkZGxld2FyZSIsInRoZW1lUGF0aCIsImluZGV4VGVtcGxhdGUiLCJwYXRoIiwiam9pbiIsInRlbXBsYXRlIiwiZnMiLCJyZWFkRmlsZVN5bmMiLCJ0b1N0cmluZyIsImxvZ29VUkkiLCJnZXQiLCJ3ZWIiLCJsb2dvIiwicG9zaXgiLCJiYXNlbmFtZSIsInJlcSIsInJlcyIsInNlbmRGaWxlIiwicmVzb2x2ZSIsImZpbGVuYW1lIiwicGFyYW1zIiwiZmlsZSIsInJlbmRlckhUTUwiLCJwcm90b2NvbCIsIkhFQURFUlMiLCJGT1JXQVJERURfUFJPVE8iLCJob3N0IiwidXJsX3ByZWZpeCIsInVyaSIsImJhc2UiLCJwcmltYXJ5Q29sb3IiLCJwcmltYXJ5X2NvbG9yIiwidGl0bGUiLCJXRUJfVElUTEUiLCJzY29wZSIsIm9wdGlvbnMiLCJ3ZWJQYWdlIiwicmVwbGFjZSIsIkpTT04iLCJzdHJpbmdpZnkiLCJ2ZXJzaW9uIiwic2V0SGVhZGVyIiwiVEVYVF9IVE1MIiwic2VuZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFJQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQWJBOzs7QUFlQSxNQUFNO0FBQUVBLEVBQUFBO0FBQUYsSUFBNEJDLE9BQU8sQ0FBQyxlQUFELENB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LFNBQUwsQ0FBZUosT0FBZixDQUR0QixFQUViRSxPQUZhLENBRUwsdUJBRkssRUFFb0JSLElBRnBCLEVBR2JRLE9BSGEsQ0FHTCxvQkFISyxFQUdpQlYsVUFIakIsRUFJYlUsT0FKYSxDQUlMLHFCQUpLLEVBSWtCNUQsT0FBTyxDQUFDK0QsT0FKMUIsRUFLYkgsT0FMYSxDQUtMLG1CQUxLLEVBS2dCTCxLQUxoQixFQU1iSyxPQU5hLENBTUwsa0JBTkssRUFNZTVCLE9BTmYsRUFPYjRCLE9BUGEsQ0FPTCwwQkFQSyxFQU91QlAsWUFQdkIsRUFRYk8sT0FSYSxDQVFMLG1CQVJLLEVBUWdCSCxLQVJoQixDQUFoQjtBQVVBbEIsSUFBQUEsR0FBRyxDQUFDeUIsU0FBSixDQUFjLGNBQWQsRUFBOEJqQixtQkFBUWtCLFNBQXRDO0FBRUExQixJQUFBQSxHQUFHLENBQUMyQixJQUFKLENBQVNQLE9BQVQ7QUFDRDs7QUFFRHhDLEVBQUFBLE1BQU0sQ0FBQ2MsR0FBUCxDQUFXLG1CQUFYLEVBQWdDLFVBQVNLLEdBQVQsRUFBY0MsR0FBZCxFQUFtQjtBQUNqRE0sSUFBQUEsVUFBVSxDQUFDUCxHQUFELEVBQU1DLEdBQU4sQ0FBVjtBQUNELEdBRkQ7QUFJQXBCLEVBQUFBLE1BQU0sQ0FBQ2MsR0FBUCxDQUFXLEdBQVgsRUFBZ0IsVUFBU0ssR0FBVCxFQUFjQyxHQUFkLEVBQW1CO0FBQ2pDTSxJQUFBQSxVQUFVLENBQUNQLEdBQUQsRUFBTUMsR0FBTixDQUFWO0FBQ0QsR0FGRDtBQUlBLFNBQU9wQixNQUFQO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBwcmV0dGllclxuICovXG5cbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuXG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBleHByZXNzIGZyb20gJ2V4cHJlc3MnO1xuXG5pbXBvcnQgeyBjb21iaW5lQmFzZVVybCwgZ2V0V2ViUHJvdG9jb2wsIGlzSFRUUFByb3RvY29sIH0gZnJvbSAnLi4vLi4vbGliL3V0aWxzJztcbmltcG9ydCBTZWFyY2ggZnJvbSAnLi4vLi4vbGliL3NlYXJjaCc7XG5pbXBvcnQgeyBIRUFERVJTLCBIVFRQX1NUQVRVUywgV0VCX1RJVExFIH0gZnJvbSAnLi4vLi4vbGliL2NvbnN0YW50cyc7XG5pbXBvcnQgbG9hZFBsdWdpbiBmcm9tICcuLi8uLi9saWIvcGx1Z2luLWxvYWRlcic7XG5cbmNvbnN0IHsgc2V0U2VjdXJpdHlXZWJIZWFkZXJzIH0gPSByZXF1aXJlKCcuLi9taWRkbGV3YXJlJyk7XG5jb25zdCBwa2dKU09OID0gcmVxdWlyZSgnLi4vLi4vLi4vcGFja2FnZS5qc29uJyk7XG5cbmV4cG9ydCBmdW5jdGlvbiBsb2FkVGhlbWUoY29uZmlnKSB7XG4gIGlmIChfLmlzTmlsKGNvbmZpZy50aGVtZSkgPT09IGZhbHNlKSB7XG4gICAgcmV0dXJuIF8uaGVhZChcbiAgICAgIGxvYWRQbHVnaW4oXG4gICAgICAgIGNvbmZpZyxcbiAgICAgICAgY29uZmlnLnRoZW1lLFxuICAgICAgICB7fSxcbiAgICAgICAgZnVuY3Rpb24ocGx1Z2luKSB7XG4gICAgICAgICAgcmV0dXJuIF8uaXNTdHJpbmcocGx1Z2luKTtcbiAgICAgICAgfSxcbiAgICAgICAgJ3ZlcmRhY2Npby10aGVtZSdcbiAgICAgIClcbiAgICApO1xuICB9XG59XG5cbmNvbnN0IHNlbmRGaWxlQ2FsbGJhY2sgPSBuZXh0ID0+IGVyciA9PiB7XG4gIGlmICghZXJyKSB7XG4gICAgcmV0dXJuO1xuICB9XG4gIGlmIChlcnIuc3RhdHVzID09PSBIVFRQX1NUQVRVUy5OT1RfRk9VTkQpIHtcbiAgICBuZXh0KCk7XG4gIH0gZWxzZSB7XG4gICAgbmV4dChlcnIpO1xuICB9XG59O1xuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbihjb25maWcsIGF1dGgsIHN0b3JhZ2UpIHtcbiAgU2VhcmNoLmNvbmZpZ3VyZVN0b3JhZ2Uoc3RvcmFnZSk7XG4gIC8qIGVzbGludCBuZXctY2FwOm9mZiAqL1xuICBjb25zdCByb3V0ZXIgPSBleHByZXNzLlJvdXRlcigpO1xuXG4gIHJvdXRlci51c2UoYXV0aC53ZWJVSUpXVG1pZGRsZXdhcmUoKSk7XG4gIHJvdXRlci51c2Uoc2V0U2VjdXJpdHlXZWJIZWFkZXJzKTtcbiAgY29uc3QgdGhlbWVQYXRoID0gbG9hZFRoZW1lKGNvbmZpZykgfHwgcmVxdWlyZSgnQHZlcmRhY2Npby91aS10aGVtZScpKCk7XG4gIGNvbnN0IGluZGV4VGVtcGxhdGUgPSBwYXRoLmpvaW4odGhlbWVQYXRoLCAnaW5kZXguaHRtbCcpO1xuICBjb25zdCB0ZW1wbGF0ZSA9IGZzLnJlYWRGaWxlU3luYyhpbmRleFRlbXBsYXRlKS50b1N0cmluZygpO1xuXG4gIC8vIExvZ29cbiAgbGV0IGxvZ29VUkkgPSBfLmdldChjb25maWcsICd3ZWIubG9nbycpID8gY29uZmlnLndlYi5sb2dvIDogJyc7XG4gIGlmIChsb2dvVVJJICYmICFpc0hUVFBQcm90b2NvbChsb2dvVVJJKSkge1xuICAgIC8vIFVSSSByZWxhdGVkIHRvIGEgbG9jYWwgZmlsZVxuXG4gICAgLy8gTm90ZTogYHBhdGguam9pbmAgd2lsbCBicmVhayBvbiBXaW5kb3dzLCBiZWNhdXNlIGl0IHRyYW5zZm9ybXMgYC9gIHRvIGBcXGBcbiAgICAvLyBVc2UgUE9TSVggdmVyc2lvbiBgcGF0aC5wb3NpeC5qb2luYCBpbnN0ZWFkLlxuICAgIGxvZ29VUkkgPSBwYXRoLnBvc2l4LmpvaW4oJy8tL3N0YXRpYy8nLCBwYXRoLmJhc2VuYW1lKGxvZ29VUkkpKTtcbiAgICByb3V0ZXIuZ2V0KGxvZ29VUkksIGZ1bmN0aW9uKHJlcSwgcmVzLCBuZXh0KSB7XG4gICAgICByZXMuc2VuZEZpbGUocGF0aC5yZXNvbHZlKGNvbmZpZy53ZWIubG9nbyksIHNlbmRGaWxlQ2FsbGJhY2sobmV4dCkpO1xuICAgIH0pO1xuICB9XG5cbiAgLy8gU3RhdGljXG4gIHJvdXRlci5nZXQoJy8tL3N0YXRpYy8qJywgZnVuY3Rpb24ocmVxLCByZXMsIG5leHQpIHtcbiAgICBjb25zdCBmaWxlbmFtZSA9IHJlcS5wYXJhbXNbMF07XG4gICAgY29uc3QgZmlsZSA9IGAke3RoZW1lUGF0aH0vJHtmaWxlbmFtZX1gO1xuICAgIHJlcy5zZW5kRmlsZShmaWxlLCBzZW5kRmlsZUNhbGxiYWNrKG5leHQpKTtcbiAgfSk7XG5cbiAgZnVuY3Rpb24gcmVuZGVySFRNTChyZXEsIHJlcykge1xuICAgIGNvbnN0IHByb3RvY29sID0gZ2V0V2ViUHJvdG9jb2wocmVxLmdldChIRUFERVJTLkZPUldBUkRFRF9QUk9UTyksIHJlcS5wcm90b2NvbCk7XG4gICAgY29uc3QgaG9zdCA9IHJlcS5nZXQoJ2hvc3QnKTtcbiAgICBjb25zdCB7IHVybF9wcmVmaXggfSA9IGNvbmZpZztcbiAgICBjb25zdCB1cmkgPSBgJHtwcm90b2NvbH06Ly8ke2hvc3R9YDtcbiAgICBjb25zdCBiYXNlID0gY29tYmluZUJhc2VVcmwocHJvdG9jb2wsIGhvc3QsIHVybF9wcmVmaXgpO1xuICAgIGNvbnN0IHByaW1hcnlDb2xvciA9IF8uZ2V0KGNvbmZpZywgJ3dlYi5wcmltYXJ5X2NvbG9yJykgPyBjb25maWcud2ViLnByaW1hcnlfY29sb3IgOiAnJztcbiAgICBjb25zdCB0aXRsZSA9IF8uZ2V0KGNvbmZpZywgJ3dlYi50aXRsZScpID8gY29uZmlnLndlYi50aXRsZSA6IFdFQl9USVRMRTtcbiAgICBjb25zdCBzY29wZSA9IF8uZ2V0KGNvbmZpZywgJ3dlYi5zY29wZScpID8gY29uZmlnLndlYi5zY29wZSA6ICcnO1xuICAgIGNvbnN0IG9wdGlvbnMgPSB7IHVyaSwgcHJvdG9jb2wsIGhvc3QsIHVybF9wcmVmaXgsIGJhc2UsIHByaW1hcnlDb2xvciwgdGl0bGUsIHNjb3BlIH07XG5cbiAgICBjb25zdCB3ZWJQYWdlID0gdGVtcGxhdGVcbiAgICAgIC5yZXBsYWNlKC9Ub1JlcGxhY2VCeVZlcmRhY2Npb1VJL2csIEpTT04uc3RyaW5naWZ5KG9wdGlvbnMpKVxuICAgICAgLnJlcGxhY2UoL1RvUmVwbGFjZUJ5VmVyZGFjY2lvL2csIGJhc2UpXG4gICAgICAucmVwbGFjZSgvVG9SZXBsYWNlQnlQcmVmaXgvZywgdXJsX3ByZWZpeClcbiAgICAgIC5yZXBsYWNlKC9Ub1JlcGxhY2VCeVZlcnNpb24vZywgcGtnSlNPTi52ZXJzaW9uKVxuICAgICAgLnJlcGxhY2UoL1RvUmVwbGFjZUJ5VGl0bGUvZywgdGl0bGUpXG4gICAgICAucmVwbGFjZSgvVG9SZXBsYWNlQnlMb2dvL2csIGxvZ29VUkkpXG4gICAgICAucmVwbGFjZSgvVG9SZXBsYWNlQnlQcmltYXJ5Q29sb3IvZywgcHJpbWFyeUNvbG9yKVxuICAgICAgLnJlcGxhY2UoL1RvUmVwbGFjZUJ5U2NvcGUvZywgc2NvcGUpO1xuXG4gICAgcmVzLnNldEhlYWRlcignQ29udGVudC1UeXBlJywgSEVBREVSUy5URVhUX0hUTUwpO1xuXG4gICAgcmVzLnNlbmQod2ViUGFnZSk7XG4gIH1cblxuICByb3V0ZXIuZ2V0KCcvLS93ZWIvOnNlY3Rpb24vKicsIGZ1bmN0aW9uKHJlcSwgcmVzKSB7XG4gICAgcmVuZGVySFRNTChyZXEsIHJlcyk7XG4gIH0pO1xuXG4gIHJvdXRlci5nZXQoJy8nLCBmdW5jdGlvbihyZXEsIHJlcykge1xuICAgIHJlbmRlckhUTUwocmVxLCByZXMpO1xuICB9KTtcblxuICByZXR1cm4gcm91dGVyO1xufVxuIl19