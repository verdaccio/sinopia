"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.startVerdaccio = startVerdaccio;
exports.listenDefaultCallback = listenDefaultCallback;

var _lodash = require("lodash");

var _url = _interopRequireDefault(require("url"));

var _fs = _interopRequireDefault(require("fs"));

var _http = _interopRequireDefault(require("http"));

var _https = _interopRequireDefault(require("https"));

var _constants = _interopRequireDefault(require("constants"));

var _index = _interopRequireDefault(require("../api/index"));

var _utils = require("./cli/utils");

var _constants2 = require("./constants");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const logger = require('./logger');

function displayExperimentsInfoBox(experiments) {
  const experimentList = Object.keys(experiments);

  if (experimentList.length >= 1) {
    logger.logger.warn('⚠️  experiments are enabled, we recommend do not use experiments in production, comment out this section to disable it');
    experimentList.forEach(experiment => {
      logger.logger.warn(` - support for ${experiment} ${experiments[experiment] ? 'is enabled' : ' is disabled'}`);
    });
  }
}
/**
 * Trigger the server after configuration has been loaded.
 * @param {Object} config
 * @param {Object} cliArguments
 * @param {String} configPath
 * @param {String} pkgVersion
 * @param {String} pkgName
 */


function startVerdaccio(config, cliListen, configPath, pkgVersion, pkgName, callback) {
  if ((0, _lodash.isObject)(config) === false) {
    throw new Error(_constants2.API_ERROR.CONFIG_BAD_FORMAT);
  }

  if ('experiments' in config) {
    displayExperimentsInfoBox(config.experiments);
  }

  (0, _index.default)(config).then(app => {
    const addresses = (0, _utils.getListListenAddresses)(cliListen, config.listen);
    addresses.forEach(function (addr) {
      let webServer;

      if (addr.proto === 'https') {
        // https  must either have key cert and ca  or a pfx and (optionally) a passphrase
        if (!config.https || !(config.https.key && config.https.cert && config.https.ca || config.https.pfx)) {
          logHTTPSWarning(configPath);
        }

        webServer = handleHTTPS(app, configPath, config);
      } else {
        // http
        webServer = _http.default.createServer(app);
      }

      if (config.server && typeof config.server.keepAliveTimeout !== 'undefined' && config.server.keepAliveTimeout !== 'null') {
        // library definition for node is not up to date (doesn't contain recent 8.0 changes)
        webServer.keepAliveTimeout = config.server.keepAliveTimeout * 1000;
      }

      unlinkAddressPath(addr);
      callback(webServer, addr, pkgName, pkgVersion);
    });
  });
}

function unlinkAddressPath(addr) {
  if (addr.path && _fs.default.existsSync(addr.path)) {
    _fs.default.unlinkSync(addr.path);
  }
}

function logHTTPSWarning(storageLocation) {
  logger.logger.fatal(['You have enabled HTTPS and need to specify either ', '    "https.key", "https.cert" and "https.ca" or ', '    "https.pfx" and optionally "https.passphrase" ', 'to run https server', '', // commands are borrowed from node.js docs
  'To quickly create self-signed certificate, use:', ' $ openssl genrsa -out ' + (0, _utils.resolveConfigPath)(storageLocation, _constants2.keyPem) + ' 2048', ' $ openssl req -new -sha256 -key ' + (0, _utils.resolveConfigPath)(storageLocation, _constants2.keyPem) + ' -out ' + (0, _utils.resolveConfigPath)(storageLocation, _constants2.csrPem), ' $ openssl x509 -req -in ' + (0, _utils.resolveConfigPath)(storageLocation, _constants2.csrPem) + ' -signkey ' + (0, _utils.resolveConfigPath)(storageLocation, _constants2.keyPem) + ' -out ' + (0, _utils.resolveConfigPath)(storageLocation, _constants2.certPem), '', 'And then add to config file (' + storageLocation + '):', '  https:', `    key: ${(0, _utils.resolveConfigPath)(storageLocation, _constants2.keyPem)}`, `    cert: ${(0, _utils.resolveConfigPath)(storageLocation, _constants2.certPem)}`, `    ca: ${(0, _utils.resolveConfigPath)(storageLocation, _constants2.csrPem)}`].join('\n'));
  process.exit(2);
}

function handleHTTPS(app, configPath, config) {
  try {
    let httpsOptions = {
      secureOptions: _constants.default.SSL_OP_NO_SSLv2 | _constants.default.SSL_OP_NO_SSLv3 // disable insecure SSLv2 and SSLv3

    };

    if (config.https.pfx) {
      httpsOptions = (0, _lodash.assign)(httpsOptions, {
        pfx: _fs.default.readFileSync(config.https.pfx),
        passphrase: config.https.passphrase || ''
      });
    } else {
      httpsOptions = (0, _lodash.assign)(httpsOptions, {
        key: _fs.default.readFileSync(config.https.key),
        cert: _fs.default.readFileSync(config.https.cert),
        ca: _fs.default.readFileSync(config.https.ca)
      });
    }

    return _https.default.createServer(httpsOptions, app);
  } catch (err) {
    // catch errors related to certificate loading
    logger.logger.fatal({
      err: err
    }, 'cannot create server: @{err.message}');
    process.exit(2);
  }
}

function listenDefaultCallback(webServer, addr, pkgName, pkgVersion) {
  webServer.listen(addr.port || addr.path, addr.host, () => {
    // send a message for tests
    if ((0, _lodash.isFunction)(process.send)) {
      process.send({
        verdaccio_started: true
      });
    }
  }).on('error', function (err) {
    logger.logger.fatal({
      err: err
    }, 'cannot create server: @{err.message}');
    process.exit(2);
  });
  logger.logger.warn({
    addr: addr.path ? _url.default.format({
      protocol: 'unix',
      pathname: addr.path
    }) : _url.default.format({
      protocol: addr.proto,
      hostname: addr.host,
      port: addr.port,
      pathname: '/'
    }),
    version: pkgName + '/' + pkgVersion
  }, 'http address - @{addr} - @{version}');
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvYm9vdHN0cmFwLnRzIl0sIm5hbWVzIjpbImxvZ2dlciIsInJlcXVpcmUiLCJkaXNwbGF5RXhwZXJpbWVudHNJbmZvQm94IiwiZXhwZXJpbWVudHMiLCJleHBlcmltZW50TGlzdCIsIk9iamVjdCIsImtleXMiLCJsZW5ndGgiLCJ3YXJuIiwiZm9yRWFjaCIsImV4cGVyaW1lbnQiLCJzdGFydFZlcmRhY2NpbyIsImNvbmZpZyIsImNsaUxpc3RlbiIsImNvbmZpZ1BhdGgiLCJwa2dWZXJzaW9uIiwicGtnTmFtZSIsImNhbGxiYWNrIiwiRXJyb3IiLCJBUElfRVJST1IiLCJDT05GSUdfQkFEX0ZPUk1BVCIsInRoZW4iLCJhcHAiLCJhZGRyZXNzZXMiLCJsaXN0ZW4iLCJhZGRyIiwid2ViU2VydmVyIiwicHJvdG8iLCJodHRwcyIsImtleSIsImNlcnQiLCJjYSIsInBmeCIsImxvZ0hUVFBTV2FybmluZyIsImhhbmRsZUhUVFBTIiwiaHR0cCIsImNyZWF0ZVNlcnZlciIsInNlcnZlciIsImtlZXBBbGl2ZVRpbWVvdXQiLCJ1bmxpbmtBZGRyZXNzUGF0aCIsInBhdGgiLCJmcyIsImV4aXN0c1N5bmMiLCJ1bmxpbmtTeW5jIiwic3RvcmFnZUxvY2F0aW9uIiwiZmF0YWwiLCJrZXlQZW0iLCJjc3JQZW0iLCJjZXJ0UGVtIiwiam9pbiIsInByb2Nlc3MiLCJleGl0IiwiaHR0cHNPcHRpb25zIiwic2VjdXJlT3B0aW9ucyIsImNvbnN0YW50cyIsIlNTTF9PUF9OT19TU0x2MiIsIlNTTF9PUF9OT19TU0x2MyIsInJlYWRGaWxlU3luYyIsInBhc3NwaHJhc2UiLCJlcnIiLCJsaXN0ZW5EZWZhdWx0Q2FsbGJhY2siLCJwb3J0IiwiaG9zdCIsInNlbmQiLCJ2ZXJkYWNjaW9fc3RhcnRlZCIsIm9uIiwiVVJMIiwiZm9ybWF0IiwicHJvdG9jb2wiLCJwYXRobmFtZSIsImhvc3RuYW1lIiwidmVyc2lvbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFBQTs7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RUFBRXZELE9BQU8sR0FBRyxHQUFWLEdBQWdCRDtBQVozQixHQURGLEVBZUUscUNBZkY7QUFpQkQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBhc3NpZ24sIGlzT2JqZWN0LCBpc0Z1bmN0aW9uIH0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBVUkwgZnJvbSAndXJsJztcbmltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgaHR0cCBmcm9tICdodHRwJztcbmltcG9ydCBodHRwcyBmcm9tICdodHRwcyc7XG5pbXBvcnQgY29uc3RhbnRzIGZyb20gJ2NvbnN0YW50cyc7XG5pbXBvcnQgZW5kUG9pbnRBUEkgZnJvbSAnLi4vYXBpL2luZGV4JztcbmltcG9ydCB7IGdldExpc3RMaXN0ZW5BZGRyZXNzZXMsIHJlc29sdmVDb25maWdQYXRoIH0gZnJvbSAnLi9jbGkvdXRpbHMnO1xuaW1wb3J0IHsgQVBJX0VSUk9SLCBjZXJ0UGVtLCBjc3JQZW0sIGtleVBlbSB9IGZyb20gJy4vY29uc3RhbnRzJztcblxuaW1wb3J0IHsgQ2FsbGJhY2sgfSBmcm9tICdAdmVyZGFjY2lvL3R5cGVzJztcbmltcG9ydCB7IEFwcGxpY2F0aW9uIH0gZnJvbSAnZXhwcmVzcyc7XG5cbmNvbnN0IGxvZ2dlciA9IHJlcXVpcmUoJy4vbG9nZ2VyJyk7XG5cbmZ1bmN0aW9uIGRpc3BsYXlFeHBlcmltZW50c0luZm9Cb3goZXhwZXJpbWVudHMpIHtcbiAgY29uc3QgZXhwZXJpbWVudExpc3QgPSBPYmplY3Qua2V5cyhleHBlcmltZW50cyk7XG4gIGlmIChleHBlcmltZW50TGlzdC5sZW5ndGggPj0gMSkge1xuICAgIGxvZ2dlci5sb2dnZXIud2Fybign4pqg77iPICBleHBlcmltZW50cyBhcmUgZW5hYmxlZCwgd2UgcmVjb21tZW5kIGRvIG5vdCB1c2UgZXhwZXJpbWVudHMgaW4gcHJvZHVjdGlvbiwgY29tbWVudCBvdXQgdGhpcyBzZWN0aW9uIHRvIGRpc2FibGUgaXQnKTtcbiAgICBleHBlcmltZW50TGlzdC5mb3JFYWNoKGV4cGVyaW1lbnQgPT4ge1xuICAgICAgbG9nZ2VyLmxvZ2dlci53YXJuKGAgLSBzdXBwb3J0IGZvciAke2V4cGVyaW1lbnR9ICR7ZXhwZXJpbWVudHNbZXhwZXJpbWVudF0gPyAnaXMgZW5hYmxlZCcgOiAnIGlzIGRpc2FibGVkJ31gKTtcbiAgICB9KTtcbiAgfVxufVxuXG4vKipcbiAqIFRyaWdnZXIgdGhlIHNlcnZlciBhZnRlciBjb25maWd1cmF0aW9uIGhhcyBiZWVuIGxvYWRlZC5cbiAqIEBwYXJhbSB7T2JqZWN0fSBjb25maWdcbiAqIEBwYXJhbSB7T2JqZWN0fSBjbGlBcmd1bWVudHNcbiAqIEBwYXJhbSB7U3RyaW5nfSBjb25maWdQYXRoXG4gKiBAcGFyYW0ge1N0cmluZ30gcGtnVmVyc2lvblxuICogQHBhcmFtIHtTdHJpbmd9IHBrZ05hbWVcbiAqL1xuZnVuY3Rpb24gc3RhcnRWZXJkYWNjaW8oY29uZmlnOiBhbnksIGNsaUxpc3Rlbjogc3RyaW5nLCBjb25maWdQYXRoOiBzdHJpbmcsIHBrZ1ZlcnNpb246IHN0cmluZywgcGtnTmFtZTogc3RyaW5nLCBjYWxsYmFjazogQ2FsbGJhY2spOiB2b2lkIHtcbiAgaWYgKGlzT2JqZWN0KGNvbmZpZykgPT09IGZhbHNlKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKEFQSV9FUlJPUi5DT05GSUdfQkFEX0ZPUk1BVCk7XG4gIH1cblxuICBpZiAoJ2V4cGVyaW1lbnRzJyBpbiBjb25maWcpIHtcbiAgICBkaXNwbGF5RXhwZXJpbWVudHNJbmZvQm94KGNvbmZpZy5leHBlcmltZW50cyk7XG4gIH1cblxuICBlbmRQb2ludEFQSShjb25maWcpLnRoZW4oXG4gICAgKGFwcCk6IHZvaWQgPT4ge1xuICAgICAgY29uc3QgYWRkcmVzc2VzID0gZ2V0TGlzdExpc3RlbkFkZHJlc3NlcyhjbGlMaXN0ZW4sIGNvbmZpZy5saXN0ZW4pO1xuXG4gICAgICBhZGRyZXNzZXMuZm9yRWFjaChmdW5jdGlvbihhZGRyKTogdm9pZCB7XG4gICAgICAgIGxldCB3ZWJTZXJ2ZXI7XG4gICAgICAgIGlmIChhZGRyLnByb3RvID09PSAnaHR0cHMnKSB7XG4gICAgICAgICAgLy8gaHR0cHMgIG11c3QgZWl0aGVyIGhhdmUga2V5IGNlcnQgYW5kIGNhICBvciBhIHBmeCBhbmQgKG9wdGlvbmFsbHkpIGEgcGFzc3BocmFzZVxuICAgICAgICAgIGlmICghY29uZmlnLmh0dHBzIHx8ICEoKGNvbmZpZy5odHRwcy5rZXkgJiYgY29uZmlnLmh0dHBzLmNlcnQgJiYgY29uZmlnLmh0dHBzLmNhKSB8fCBjb25maWcuaHR0cHMucGZ4KSkge1xuICAgICAgICAgICAgbG9nSFRUUFNXYXJuaW5nKGNvbmZpZ1BhdGgpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHdlYlNlcnZlciA9IGhhbmRsZUhUVFBTKGFwcCwgY29uZmlnUGF0aCwgY29uZmlnKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyBodHRwXG4gICAgICAgICAgd2ViU2VydmVyID0gaHR0cC5jcmVhdGVTZXJ2ZXIoYXBwKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoY29uZmlnLnNlcnZlciAmJiB0eXBlb2YgY29uZmlnLnNlcnZlci5rZWVwQWxpdmVUaW1lb3V0ICE9PSAndW5kZWZpbmVkJyAmJiBjb25maWcuc2VydmVyLmtlZXBBbGl2ZVRpbWVvdXQgIT09ICdudWxsJykge1xuICAgICAgICAgIC8vIGxpYnJhcnkgZGVmaW5pdGlvbiBmb3Igbm9kZSBpcyBub3QgdXAgdG8gZGF0ZSAoZG9lc24ndCBjb250YWluIHJlY2VudCA4LjAgY2hhbmdlcylcbiAgICAgICAgICB3ZWJTZXJ2ZXIua2VlcEFsaXZlVGltZW91dCA9IGNvbmZpZy5zZXJ2ZXIua2VlcEFsaXZlVGltZW91dCAqIDEwMDA7XG4gICAgICAgIH1cbiAgICAgICAgdW5saW5rQWRkcmVzc1BhdGgoYWRkcik7XG5cbiAgICAgICAgY2FsbGJhY2sod2ViU2VydmVyLCBhZGRyLCBwa2dOYW1lLCBwa2dWZXJzaW9uKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgKTtcbn1cblxuZnVuY3Rpb24gdW5saW5rQWRkcmVzc1BhdGgoYWRkcikge1xuICBpZiAoYWRkci5wYXRoICYmIGZzLmV4aXN0c1N5bmMoYWRkci5wYXRoKSkge1xuICAgIGZzLnVubGlua1N5bmMoYWRkci5wYXRoKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBsb2dIVFRQU1dhcm5pbmcoc3RvcmFnZUxvY2F0aW9uKSB7XG4gIGxvZ2dlci5sb2dnZXIuZmF0YWwoXG4gICAgW1xuICAgICAgJ1lvdSBoYXZlIGVuYWJsZWQgSFRUUFMgYW5kIG5lZWQgdG8gc3BlY2lmeSBlaXRoZXIgJyxcbiAgICAgICcgICAgXCJodHRwcy5rZXlcIiwgXCJodHRwcy5jZXJ0XCIgYW5kIFwiaHR0cHMuY2FcIiBvciAnLFxuICAgICAgJyAgICBcImh0dHBzLnBmeFwiIGFuZCBvcHRpb25hbGx5IFwiaHR0cHMucGFzc3BocmFzZVwiICcsXG4gICAgICAndG8gcnVuIGh0dHBzIHNlcnZlcicsXG4gICAgICAnJyxcbiAgICAgIC8vIGNvbW1hbmRzIGFyZSBib3Jyb3dlZCBmcm9tIG5vZGUuanMgZG9jc1xuICAgICAgJ1RvIHF1aWNrbHkgY3JlYXRlIHNlbGYtc2lnbmVkIGNlcnRpZmljYXRlLCB1c2U6JyxcbiAgICAgICcgJCBvcGVuc3NsIGdlbnJzYSAtb3V0ICcgKyByZXNvbHZlQ29uZmlnUGF0aChzdG9yYWdlTG9jYXRpb24sIGtleVBlbSkgKyAnIDIwNDgnLFxuICAgICAgJyAkIG9wZW5zc2wgcmVxIC1uZXcgLXNoYTI1NiAta2V5ICcgKyByZXNvbHZlQ29uZmlnUGF0aChzdG9yYWdlTG9jYXRpb24sIGtleVBlbSkgKyAnIC1vdXQgJyArIHJlc29sdmVDb25maWdQYXRoKHN0b3JhZ2VMb2NhdGlvbiwgY3NyUGVtKSxcbiAgICAgICcgJCBvcGVuc3NsIHg1MDkgLXJlcSAtaW4gJyArXG4gICAgICAgIHJlc29sdmVDb25maWdQYXRoKHN0b3JhZ2VMb2NhdGlvbiwgY3NyUGVtKSArXG4gICAgICAgICcgLXNpZ25rZXkgJyArXG4gICAgICAgIHJlc29sdmVDb25maWdQYXRoKHN0b3JhZ2VMb2NhdGlvbiwga2V5UGVtKSArXG4gICAgICAgICcgLW91dCAnICtcbiAgICAgICAgcmVzb2x2ZUNvbmZpZ1BhdGgoc3RvcmFnZUxvY2F0aW9uLCBjZXJ0UGVtKSxcbiAgICAgICcnLFxuICAgICAgJ0FuZCB0aGVuIGFkZCB0byBjb25maWcgZmlsZSAoJyArIHN0b3JhZ2VMb2NhdGlvbiArICcpOicsXG4gICAgICAnICBodHRwczonLFxuICAgICAgYCAgICBrZXk6ICR7cmVzb2x2ZUNvbmZpZ1BhdGgoc3RvcmFnZUxvY2F0aW9uLCBrZXlQZW0pfWAsXG4gICAgICBgICAgIGNlcnQ6ICR7cmVzb2x2ZUNvbmZpZ1BhdGgoc3RvcmFnZUxvY2F0aW9uLCBjZXJ0UGVtKX1gLFxuICAgICAgYCAgICBjYTogJHtyZXNvbHZlQ29uZmlnUGF0aChzdG9yYWdlTG9jYXRpb24sIGNzclBlbSl9YCxcbiAgICBdLmpvaW4oJ1xcbicpXG4gICk7XG4gIHByb2Nlc3MuZXhpdCgyKTtcbn1cblxuZnVuY3Rpb24gaGFuZGxlSFRUUFMoYXBwLCBjb25maWdQYXRoLCBjb25maWcpIHtcbiAgdHJ5IHtcbiAgICBsZXQgaHR0cHNPcHRpb25zID0ge1xuICAgICAgc2VjdXJlT3B0aW9uczogY29uc3RhbnRzLlNTTF9PUF9OT19TU0x2MiB8IGNvbnN0YW50cy5TU0xfT1BfTk9fU1NMdjMsIC8vIGRpc2FibGUgaW5zZWN1cmUgU1NMdjIgYW5kIFNTTHYzXG4gICAgfTtcblxuICAgIGlmIChjb25maWcuaHR0cHMucGZ4KSB7XG4gICAgICBodHRwc09wdGlvbnMgPSBhc3NpZ24oaHR0cHNPcHRpb25zLCB7XG4gICAgICAgIHBmeDogZnMucmVhZEZpbGVTeW5jKGNvbmZpZy5odHRwcy5wZngpLFxuICAgICAgICBwYXNzcGhyYXNlOiBjb25maWcuaHR0cHMucGFzc3BocmFzZSB8fCAnJyxcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBodHRwc09wdGlvbnMgPSBhc3NpZ24oaHR0cHNPcHRpb25zLCB7XG4gICAgICAgIGtleTogZnMucmVhZEZpbGVTeW5jKGNvbmZpZy5odHRwcy5rZXkpLFxuICAgICAgICBjZXJ0OiBmcy5yZWFkRmlsZVN5bmMoY29uZmlnLmh0dHBzLmNlcnQpLFxuICAgICAgICBjYTogZnMucmVhZEZpbGVTeW5jKGNvbmZpZy5odHRwcy5jYSksXG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIGh0dHBzLmNyZWF0ZVNlcnZlcihodHRwc09wdGlvbnMsIGFwcCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIC8vIGNhdGNoIGVycm9ycyByZWxhdGVkIHRvIGNlcnRpZmljYXRlIGxvYWRpbmdcbiAgICBsb2dnZXIubG9nZ2VyLmZhdGFsKHsgZXJyOiBlcnIgfSwgJ2Nhbm5vdCBjcmVhdGUgc2VydmVyOiBAe2Vyci5tZXNzYWdlfScpO1xuICAgIHByb2Nlc3MuZXhpdCgyKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBsaXN0ZW5EZWZhdWx0Q2FsbGJhY2sod2ViU2VydmVyOiBBcHBsaWNhdGlvbiwgYWRkcjogYW55LCBwa2dOYW1lOiBzdHJpbmcsIHBrZ1ZlcnNpb246IHN0cmluZyk6IHZvaWQge1xuICB3ZWJTZXJ2ZXJcbiAgICAubGlzdGVuKFxuICAgICAgYWRkci5wb3J0IHx8IGFkZHIucGF0aCxcbiAgICAgIGFkZHIuaG9zdCxcbiAgICAgICgpOiB2b2lkID0+IHtcbiAgICAgICAgLy8gc2VuZCBhIG1lc3NhZ2UgZm9yIHRlc3RzXG4gICAgICAgIGlmIChpc0Z1bmN0aW9uKHByb2Nlc3Muc2VuZCkpIHtcbiAgICAgICAgICBwcm9jZXNzLnNlbmQoe1xuICAgICAgICAgICAgdmVyZGFjY2lvX3N0YXJ0ZWQ6IHRydWUsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICApXG4gICAgLm9uKCdlcnJvcicsIGZ1bmN0aW9uKGVycik6IHZvaWQge1xuICAgICAgbG9nZ2VyLmxvZ2dlci5mYXRhbCh7IGVycjogZXJyIH0sICdjYW5ub3QgY3JlYXRlIHNlcnZlcjogQHtlcnIubWVzc2FnZX0nKTtcbiAgICAgIHByb2Nlc3MuZXhpdCgyKTtcbiAgICB9KTtcblxuICBsb2dnZXIubG9nZ2VyLndhcm4oXG4gICAge1xuICAgICAgYWRkcjogYWRkci5wYXRoXG4gICAgICAgID8gVVJMLmZvcm1hdCh7XG4gICAgICAgICAgICBwcm90b2NvbDogJ3VuaXgnLFxuICAgICAgICAgICAgcGF0aG5hbWU6IGFkZHIucGF0aCxcbiAgICAgICAgICB9KVxuICAgICAgICA6IFVSTC5mb3JtYXQoe1xuICAgICAgICAgICAgcHJvdG9jb2w6IGFkZHIucHJvdG8sXG4gICAgICAgICAgICBob3N0bmFtZTogYWRkci5ob3N0LFxuICAgICAgICAgICAgcG9ydDogYWRkci5wb3J0LFxuICAgICAgICAgICAgcGF0aG5hbWU6ICcvJyxcbiAgICAgICAgICB9KSxcbiAgICAgIHZlcnNpb246IHBrZ05hbWUgKyAnLycgKyBwa2dWZXJzaW9uLFxuICAgIH0sXG4gICAgJ2h0dHAgYWRkcmVzcyAtIEB7YWRkcn0gLSBAe3ZlcnNpb259J1xuICApO1xufVxuXG5leHBvcnQgeyBzdGFydFZlcmRhY2NpbywgbGlzdGVuRGVmYXVsdENhbGxiYWNrIH07XG4iXX0=