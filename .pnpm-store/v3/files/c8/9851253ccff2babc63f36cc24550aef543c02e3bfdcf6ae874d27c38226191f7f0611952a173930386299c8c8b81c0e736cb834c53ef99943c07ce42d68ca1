"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _commonsApi = require("@verdaccio/commons-api");

var _memoryFs = _interopRequireDefault(require("memory-fs"));

var _streams = require("@verdaccio/streams");

var _utils = require("./utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const fs = new _memoryFs.default();

class MemoryHandler {
  constructor(packageName, data, logger) {
    _defineProperty(this, "data", void 0);

    _defineProperty(this, "name", void 0);

    _defineProperty(this, "path", void 0);

    _defineProperty(this, "logger", void 0);

    // this is not need it
    this.data = data;
    this.name = packageName;
    this.logger = logger;
    this.path = '/';
  }

  updatePackage(pkgFileName, updateHandler, onWrite, transformPackage, onEnd) {
    const json = this._getStorage(pkgFileName);

    let pkg;

    try {
      pkg = (0, _utils.parsePackage)(json);
    } catch (err) {
      return onEnd(err);
    }

    updateHandler(pkg, err => {
      if (err) {
        return onEnd(err);
      }

      try {
        onWrite(pkgFileName, transformPackage(pkg), onEnd);
      } catch (err) {
        return onEnd((0, _commonsApi.getInternalError)('error on parse the metadata'));
      }
    });
  }

  deletePackage(pkgName, callback) {
    delete this.data[pkgName];
    return callback(null);
  }

  removePackage(callback) {
    return callback(null);
  }

  createPackage(name, value, cb) {
    this.savePackage(name, value, cb);
  }

  savePackage(name, value, cb) {
    try {
      const json = (0, _utils.stringifyPackage)(value);
      this.data[name] = json;
      return cb(null);
    } catch (err) {
      return cb((0, _commonsApi.getInternalError)(err.message));
    }
  }

  readPackage(name, cb) {
    const json = this._getStorage(name);

    const isJson = typeof json === 'undefined';

    try {
      return cb(isJson ? (0, _commonsApi.getNotFound)() : null, (0, _utils.parsePackage)(json));
    } catch (err) {
      return cb((0, _commonsApi.getNotFound)());
    }
  }

  writeTarball(name) {
    const uploadStream = new _streams.UploadTarball({});
    const temporalName = `/${name}`;
    process.nextTick(function () {
      fs.stat(temporalName, function (fileError, stats) {
        if (!fileError && stats) {
          return uploadStream.emit('error', (0, _commonsApi.getConflict)());
        }

        try {
          const file = fs.createWriteStream(temporalName);
          uploadStream.pipe(file);

          uploadStream.done = function () {
            const onEnd = function () {
              uploadStream.emit('success');
            };

            uploadStream.on('end', onEnd);
          };

          uploadStream.abort = function () {
            uploadStream.emit('error', (0, _commonsApi.getBadRequest)('transmision aborted'));
            file.end();
          };

          uploadStream.emit('open');
          return;
        } catch (err) {
          uploadStream.emit('error', err);
          return;
        }
      });
    });
    return uploadStream;
  }

  readTarball(name) {
    const pathName = `/${name}`;
    const readTarballStream = new _streams.ReadTarball({});
    process.nextTick(function () {
      fs.stat(pathName, function (fileError, stats) {
        if (fileError && !stats) {
          return readTarballStream.emit('error', (0, _commonsApi.getNotFound)());
        }

        try {
          const readStream = fs.createReadStream(pathName);
          const contentLength = fs.data[name] && fs.data[name].length || 0;
          readTarballStream.emit('content-length', contentLength);
          readTarballStream.emit('open');
          readStream.pipe(readTarballStream);
          readStream.on('error', error => {
            readTarballStream.emit('error', error);
          });

          readTarballStream.abort = function () {
            readStream.destroy((0, _commonsApi.getBadRequest)('read has been aborted'));
          };

          return;
        } catch (err) {
          readTarballStream.emit('error', err);
          return;
        }
      });
    });
    return readTarballStream;
  }

  _getStorage(name = '') {
    return this.data[name];
  }

}

var _default = MemoryHandler;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tZW1vcnktaGFuZGxlci50cyJdLCJuYW1lcyI6WyJmcyIsIk1lbW9yeUZpbGVTeXN0ZW0iLCJNZW1vcnlIYW5kbGVyIiwiY29uc3RydWN0b3IiLCJwYWNrYWdlTmFtZSIsImRhdGEiLCJsb2dnZXIiLCJuYW1lIiwicGF0aCIsInVwZGF0ZVBhY2thZ2UiLCJwa2dGaWxlTmFtZSIsInVwZGF0ZUhhbmRsZXIiLCJvbldyaXRlIiwidHJhbnNmb3JtUGFja2FnZSIsIm9uRW5kIiwianNvbiIsIl9nZXRTdG9yYWdlIiwicGtnIiwiZXJyIiwiZGVsZXRlUGFja2FnZSIsInBrZ05hbWUiLCJjYWxsYmFjayIsInJlbW92ZVBhY2thZ2UiLCJjcmVhdGVQYWNrYWdlIiwidmFsdWUiLCJjYiIsInNhdmVQYWNrYWdlIiwibWVzc2FnZSIsInJlYWRQYWNrYWdlIiwiaXNKc29uIiwid3JpdGVUYXJiYWxsIiwidXBsb2FkU3RyZWFtIiwiVXBsb2FkVGFyYmFsbCIsInRlbXBvcmFsTmFtZSIsInByb2Nlc3MiLCJuZXh0VGljayIsInN0YXQiLCJmaWxlRXJyb3IiLCJzdGF0cyIsImVtaXQiLCJmaWxlIiwiY3JlYXRlV3JpdGVTdHJlYW0iLCJwaXBlIiwiZG9uZSIsIm9uIiwiYWJvcnQiLCJlbmQiLCJyZWFkVGFyYmFsbCIsInBhdGhOYW1lIiwicmVhZFRhcmJhbGxTdHJlYW0iLCJSZWFkVGFyYmFsbCIsInJlYWRTdHJlYW0iLCJjcmVhdGVSZWFkU3RyZWFtIiwiY29udGVudExlbmd0aCIsImxlbmd0aCIsImVycm9yIiwiZGVzdHJveSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQWVBOzs7Ozs7QUFFQSxNQUFNQSxFQUFFLEdBQUcsSUFBSUMsaUJBQUosRUFBWDs7QUFNQSxNQUFNQyxhQUFOLENBQXNEO0FBTTdDQyxFQUFBQSxXQUFQLENBQW1CQyxXQUFuQixFQUF3Q0MsSUFBeEMsRUFBMkRDLE1BQTNELEVBQTJFO0FBQUE7O0FBQUE7O0FB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ckIsR0FBaEM7QUFDQTtBQUNEO0FBQ0YsT0F4QkQ7QUF5QkQsS0ExQkQ7QUE0QkEsV0FBTytCLGlCQUFQO0FBQ0Q7O0FBRU9qQyxFQUFBQSxXQUFSLENBQW9CVCxJQUFJLEdBQUcsRUFBM0IsRUFBdUM7QUFDckMsV0FBTyxLQUFLRixJQUFMLENBQVVFLElBQVYsQ0FBUDtBQUNEOztBQTNKbUQ7O2VBOEp2Q0wsYSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFZlcmRhY2Npb0Vycm9yLCBnZXRCYWRSZXF1ZXN0LCBnZXRJbnRlcm5hbEVycm9yLCBnZXRDb25mbGljdCwgZ2V0Tm90Rm91bmQgfSBmcm9tICdAdmVyZGFjY2lvL2NvbW1vbnMtYXBpJztcbmltcG9ydCBNZW1vcnlGaWxlU3lzdGVtIGZyb20gJ21lbW9yeS1mcyc7XG5pbXBvcnQgeyBVcGxvYWRUYXJiYWxsLCBSZWFkVGFyYmFsbCB9IGZyb20gJ0B2ZXJkYWNjaW8vc3RyZWFtcyc7XG5pbXBvcnQge1xuICBDYWxsYmFjayxcbiAgTG9nZ2VyLFxuICBJUGFja2FnZVN0b3JhZ2VNYW5hZ2VyLFxuICBJVXBsb2FkVGFyYmFsbCxcbiAgSVJlYWRUYXJiYWxsLFxuICBDYWxsYmFja0FjdGlvbixcbiAgU3RvcmFnZVVwZGF0ZUNhbGxiYWNrLFxuICBTdG9yYWdlV3JpdGVDYWxsYmFjayxcbiAgUGFja2FnZVRyYW5zZm9ybWVyLFxuICBQYWNrYWdlLFxuICBSZWFkUGFja2FnZUNhbGxiYWNrLFxufSBmcm9tICdAdmVyZGFjY2lvL3R5cGVzJztcblxuaW1wb3J0IHsgcGFyc2VQYWNrYWdlLCBzdHJpbmdpZnlQYWNrYWdlIH0gZnJvbSAnLi91dGlscyc7XG5cbmNvbnN0IGZzID0gbmV3IE1lbW9yeUZpbGVTeXN0ZW0oKTtcblxuZXhwb3J0IHR5cGUgRGF0YUhhbmRsZXIgPSB7XG4gIFtrZXk6IHN0cmluZ106IHN0cmluZztcbn07XG5cbmNsYXNzIE1lbW9yeUhhbmRsZXIgaW1wbGVtZW50cyBJUGFja2FnZVN0b3JhZ2VNYW5hZ2VyIHtcbiAgcHJpdmF0ZSBkYXRhOiBEYXRhSGFuZGxlcjtcbiAgcHJpdmF0ZSBuYW1lOiBzdHJpbmc7XG4gIHByaXZhdGUgcGF0aDogc3RyaW5nO1xuICBwdWJsaWMgbG9nZ2VyOiBMb2dnZXI7XG5cbiAgcHVibGljIGNvbnN0cnVjdG9yKHBhY2thZ2VOYW1lOiBzdHJpbmcsIGRhdGE6IERhdGFIYW5kbGVyLCBsb2dnZXI6IExvZ2dlcikge1xuICAgIC8vIHRoaXMgaXMgbm90IG5lZWQgaXRcbiAgICB0aGlzLmRhdGEgPSBkYXRhO1xuICAgIHRoaXMubmFtZSA9IHBhY2thZ2VOYW1lO1xuICAgIHRoaXMubG9nZ2VyID0gbG9nZ2VyO1xuICAgIHRoaXMucGF0aCA9ICcvJztcbiAgfVxuXG4gIHB1YmxpYyB1cGRhdGVQYWNrYWdlKFxuICAgIHBrZ0ZpbGVOYW1lOiBzdHJpbmcsXG4gICAgdXBkYXRlSGFuZGxlcjogU3RvcmFnZVVwZGF0ZUNhbGxiYWNrLFxuICAgIG9uV3JpdGU6IFN0b3JhZ2VXcml0ZUNhbGxiYWNrLFxuICAgIHRyYW5zZm9ybVBhY2thZ2U6IFBhY2thZ2VUcmFuc2Zvcm1lcixcbiAgICBvbkVuZDogQ2FsbGJhY2tBY3Rpb25cbiAgKTogdm9pZCB7XG4gICAgY29uc3QganNvbjogc3RyaW5nID0gdGhpcy5fZ2V0U3RvcmFnZShwa2dGaWxlTmFtZSk7XG4gICAgbGV0IHBrZzogUGFja2FnZTtcblxuICAgIHRyeSB7XG4gICAgICBwa2cgPSBwYXJzZVBhY2thZ2UoanNvbikgYXMgUGFja2FnZTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHJldHVybiBvbkVuZChlcnIpO1xuICAgIH1cblxuICAgIHVwZGF0ZUhhbmRsZXIocGtnLCAoZXJyOiBWZXJkYWNjaW9FcnJvcikgPT4ge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICByZXR1cm4gb25FbmQoZXJyKTtcbiAgICAgIH1cbiAgICAgIHRyeSB7XG4gICAgICAgIG9uV3JpdGUocGtnRmlsZU5hbWUsIHRyYW5zZm9ybVBhY2thZ2UocGtnKSwgb25FbmQpO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIHJldHVybiBvbkVuZChnZXRJbnRlcm5hbEVycm9yKCdlcnJvciBvbiBwYXJzZSB0aGUgbWV0YWRhdGEnKSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgZGVsZXRlUGFja2FnZShwa2dOYW1lOiBzdHJpbmcsIGNhbGxiYWNrOiBDYWxsYmFjayk6IHZvaWQge1xuICAgIGRlbGV0ZSB0aGlzLmRhdGFbcGtnTmFtZV07XG4gICAgcmV0dXJuIGNhbGxiYWNrKG51bGwpO1xuICB9XG5cbiAgcHVibGljIHJlbW92ZVBhY2thZ2UoY2FsbGJhY2s6IENhbGxiYWNrQWN0aW9uKTogdm9pZCB7XG4gICAgcmV0dXJuIGNhbGxiYWNrKG51bGwpO1xuICB9XG5cbiAgcHVibGljIGNyZWF0ZVBhY2thZ2UobmFtZTogc3RyaW5nLCB2YWx1ZTogUGFja2FnZSwgY2I6IENhbGxiYWNrQWN0aW9uKTogdm9pZCB7XG4gICAgdGhpcy5zYXZlUGFja2FnZShuYW1lLCB2YWx1ZSwgY2IpO1xuICB9XG5cbiAgcHVibGljIHNhdmVQYWNrYWdlKG5hbWU6IHN0cmluZywgdmFsdWU6IFBhY2thZ2UsIGNiOiBDYWxsYmFja0FjdGlvbik6IHZvaWQge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBqc29uOiBzdHJpbmcgPSBzdHJpbmdpZnlQYWNrYWdlKHZhbHVlKTtcblxuICAgICAgdGhpcy5kYXRhW25hbWVdID0ganNvbjtcbiAgICAgIHJldHVybiBjYihudWxsKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHJldHVybiBjYihnZXRJbnRlcm5hbEVycm9yKGVyci5tZXNzYWdlKSk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHJlYWRQYWNrYWdlKG5hbWU6IHN0cmluZywgY2I6IFJlYWRQYWNrYWdlQ2FsbGJhY2spOiB2b2lkIHtcbiAgICBjb25zdCBqc29uID0gdGhpcy5fZ2V0U3RvcmFnZShuYW1lKTtcbiAgICBjb25zdCBpc0pzb24gPSB0eXBlb2YganNvbiA9PT0gJ3VuZGVmaW5lZCc7XG5cbiAgICB0cnkge1xuICAgICAgcmV0dXJuIGNiKGlzSnNvbiA/IGdldE5vdEZvdW5kKCkgOiBudWxsLCBwYXJzZVBhY2thZ2UoanNvbikpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgcmV0dXJuIGNiKGdldE5vdEZvdW5kKCkpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyB3cml0ZVRhcmJhbGwobmFtZTogc3RyaW5nKTogSVVwbG9hZFRhcmJhbGwge1xuICAgIGNvbnN0IHVwbG9hZFN0cmVhbTogSVVwbG9hZFRhcmJhbGwgPSBuZXcgVXBsb2FkVGFyYmFsbCh7fSk7XG4gICAgY29uc3QgdGVtcG9yYWxOYW1lID0gYC8ke25hbWV9YDtcblxuICAgIHByb2Nlc3MubmV4dFRpY2soZnVuY3Rpb24oKSB7XG4gICAgICBmcy5zdGF0KHRlbXBvcmFsTmFtZSwgZnVuY3Rpb24oZmlsZUVycm9yLCBzdGF0cykge1xuICAgICAgICBpZiAoIWZpbGVFcnJvciAmJiBzdGF0cykge1xuICAgICAgICAgIHJldHVybiB1cGxvYWRTdHJlYW0uZW1pdCgnZXJyb3InLCBnZXRDb25mbGljdCgpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgY29uc3QgZmlsZSA9IGZzLmNyZWF0ZVdyaXRlU3RyZWFtKHRlbXBvcmFsTmFtZSk7XG5cbiAgICAgICAgICB1cGxvYWRTdHJlYW0ucGlwZShmaWxlKTtcblxuICAgICAgICAgIHVwbG9hZFN0cmVhbS5kb25lID0gZnVuY3Rpb24oKTogdm9pZCB7XG4gICAgICAgICAgICBjb25zdCBvbkVuZCA9IGZ1bmN0aW9uKCk6IHZvaWQge1xuICAgICAgICAgICAgICB1cGxvYWRTdHJlYW0uZW1pdCgnc3VjY2VzcycpO1xuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgdXBsb2FkU3RyZWFtLm9uKCdlbmQnLCBvbkVuZCk7XG4gICAgICAgICAgfTtcblxuICAgICAgICAgIHVwbG9hZFN0cmVhbS5hYm9ydCA9IGZ1bmN0aW9uKCk6IHZvaWQge1xuICAgICAgICAgICAgdXBsb2FkU3RyZWFtLmVtaXQoJ2Vycm9yJywgZ2V0QmFkUmVxdWVzdCgndHJhbnNtaXNpb24gYWJvcnRlZCcpKTtcbiAgICAgICAgICAgIGZpbGUuZW5kKCk7XG4gICAgICAgICAgfTtcblxuICAgICAgICAgIHVwbG9hZFN0cmVhbS5lbWl0KCdvcGVuJyk7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICB1cGxvYWRTdHJlYW0uZW1pdCgnZXJyb3InLCBlcnIpO1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gdXBsb2FkU3RyZWFtO1xuICB9XG5cbiAgcHVibGljIHJlYWRUYXJiYWxsKG5hbWU6IHN0cmluZyk6IElSZWFkVGFyYmFsbCB7XG4gICAgY29uc3QgcGF0aE5hbWUgPSBgLyR7bmFtZX1gO1xuXG4gICAgY29uc3QgcmVhZFRhcmJhbGxTdHJlYW06IElSZWFkVGFyYmFsbCA9IG5ldyBSZWFkVGFyYmFsbCh7fSk7XG5cbiAgICBwcm9jZXNzLm5leHRUaWNrKGZ1bmN0aW9uKCkge1xuICAgICAgZnMuc3RhdChwYXRoTmFtZSwgZnVuY3Rpb24oZmlsZUVycm9yLCBzdGF0cykge1xuICAgICAgICBpZiAoZmlsZUVycm9yICYmICFzdGF0cykge1xuICAgICAgICAgIHJldHVybiByZWFkVGFyYmFsbFN0cmVhbS5lbWl0KCdlcnJvcicsIGdldE5vdEZvdW5kKCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBjb25zdCByZWFkU3RyZWFtID0gZnMuY3JlYXRlUmVhZFN0cmVhbShwYXRoTmFtZSk7XG5cbiAgICAgICAgICBjb25zdCBjb250ZW50TGVuZ3RoOiBudW1iZXIgPSAoZnMuZGF0YVtuYW1lXSAmJiBmcy5kYXRhW25hbWVdLmxlbmd0aCkgfHwgMDtcbiAgICAgICAgICByZWFkVGFyYmFsbFN0cmVhbS5lbWl0KCdjb250ZW50LWxlbmd0aCcsIGNvbnRlbnRMZW5ndGgpO1xuICAgICAgICAgIHJlYWRUYXJiYWxsU3RyZWFtLmVtaXQoJ29wZW4nKTtcbiAgICAgICAgICByZWFkU3RyZWFtLnBpcGUocmVhZFRhcmJhbGxTdHJlYW0pO1xuICAgICAgICAgIHJlYWRTdHJlYW0ub24oJ2Vycm9yJywgKGVycm9yOiBWZXJkYWNjaW9FcnJvcikgPT4ge1xuICAgICAgICAgICAgcmVhZFRhcmJhbGxTdHJlYW0uZW1pdCgnZXJyb3InLCBlcnJvcik7XG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgICByZWFkVGFyYmFsbFN0cmVhbS5hYm9ydCA9IGZ1bmN0aW9uKCk6IHZvaWQge1xuICAgICAgICAgICAgcmVhZFN0cmVhbS5kZXN0cm95KGdldEJhZFJlcXVlc3QoJ3JlYWQgaGFzIGJlZW4gYWJvcnRlZCcpKTtcbiAgICAgICAgICB9O1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgcmVhZFRhcmJhbGxTdHJlYW0uZW1pdCgnZXJyb3InLCBlcnIpO1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gcmVhZFRhcmJhbGxTdHJlYW07XG4gIH1cblxuICBwcml2YXRlIF9nZXRTdG9yYWdlKG5hbWUgPSAnJyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuZGF0YVtuYW1lXTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBNZW1vcnlIYW5kbGVyO1xuIl19