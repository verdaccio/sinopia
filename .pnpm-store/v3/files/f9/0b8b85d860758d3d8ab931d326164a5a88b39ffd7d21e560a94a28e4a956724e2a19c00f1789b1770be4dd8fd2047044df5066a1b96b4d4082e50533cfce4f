"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _lodash = _interopRequireDefault(require("lodash"));

var _express = _interopRequireDefault(require("express"));

var _bodyParser = _interopRequireDefault(require("body-parser"));

var _compression = _interopRequireDefault(require("compression"));

var _cors = _interopRequireDefault(require("cors"));

var _storage = _interopRequireDefault(require("../lib/storage"));

var _pluginLoader = _interopRequireDefault(require("../lib/plugin-loader"));

var _debug = _interopRequireDefault(require("./debug"));

var _auth = _interopRequireDefault(require("../lib/auth"));

var _endpoint = _interopRequireDefault(require("./endpoint"));

var _utils = require("../lib/utils");

var _constants = require("../lib/constants");

var _config = _interopRequireDefault(require("../lib/config"));

var _api = _interopRequireDefault(require("./web/api"));

var _web = _interopRequireDefault(require("./web"));

var _logger = require("../lib/logger");

var _middleware = require("./middleware");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const defineAPI = function (config, storage) {
  const auth = new _auth.default(config);
  const app = (0, _express.default)(); // run in production mode by default, just in case
  // it shouldn't make any difference anyway

  app.set('env', process.env.NODE_ENV || 'production');
  app.use((0, _cors.default)()); // Router setup

  app.use(_middleware.log);
  app.use(_middleware.errorReportingMiddleware);
  app.use(function (req, res, next) {
    res.setHeader('X-Powered-By', config.user_agent);
    next();
  });
  app.use((0, _compression.default)());
  app.get('/favicon.ico', function (req, res, next) {
    req.url = '/-/static/favicon.png';
    next();
  }); // Hook for tests only

  if (config._debug) {
    (0, _debug.default)(app, config.self_path);
  }

  app.use(_bodyParser.default.json({
    strict: false,
    limit: config.max_body_size || '10mb'
  })); // register middleware plugins

  const plugin_params = {
    config: config,
    logger: _logger.logger
  };
  const plugins = (0, _pluginLoader.default)(config, config.middlewares, plugin_params, function (plugin) {
    return plugin.register_middlewares;
  });
  plugins.forEach(plugin => {
    plugin.register_middlewares(app, auth, storage);
  }); // For  npm request

  app.use((0, _endpoint.default)(config, auth, storage)); // For WebUI & WebUI API

  if (_lodash.default.get(config, 'web.enable', true)) {
    app.use('/', (0, _web.default)(config, auth, storage));
    app.use('/-/verdaccio/', (0, _api.default)(config, auth, storage));
  } else {
    app.get('/', function (req, res, next) {
      next(_utils.ErrorCode.getNotFound(_constants.API_ERROR.WEB_DISABLED));
    });
  } // Catch 404


  app.get('/*', function (req, res, next) {
    next(_utils.ErrorCode.getNotFound(_constants.API_ERROR.FILE_NOT_FOUND));
  });
  app.use(function (err, req, res, next) {
    if (_lodash.default.isError(err)) {
      if (err.code === 'ECONNABORT' && res.statusCode === _constants.HTTP_STATUS.NOT_MODIFIED) {
        return next();
      }

      if (_lodash.default.isFunction(res.report_error) === false) {
        // in case of very early error this middleware may not be loaded before error is generated
        // fixing that
        (0, _middleware.errorReportingMiddleware)(req, res, _lodash.default.noop);
      }

      res.report_error(err);
    } else {
      // Fall to Middleware.final
      return next(err);
    }
  });
  app.use(_middleware.final);
  return app;
};

var _default = async function _default(configHash) {
  (0, _logger.setup)(configHash.logs);
  const config = new _config.default(_lodash.default.cloneDeep(configHash)); // register middleware plugins

  const plugin_params = {
    config: config,
    logger: _logger.logger
  };
  const filters = (0, _pluginLoader.default)(config, config.filters || {}, plugin_params, plugin => plugin.filter_metadata);
  const storage = new _storage.default(config); // waits until init calls have been initialized

  await storage.init(config, filters);
  return defineAPI(config, storage);
};

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hcGkvaW5kZXgudHMiXSwibmFtZXMiOlsiZGVmaW5lQVBJIiwiY29uZmlnIiwic3RvcmFnZSIsImF1dGgiLCJBdXRoIiwiYXBwIiwic2V0IiwicHJvY2VzcyIsImVudiIsIk5PREVfRU5WIiwidXNlIiwibG9nIiwiZXJyb3JSZXBvcnRpbmdNaWRkbGV3YXJlIiwicmVxIiwicmVzIiwibmV4dCIsInNldEhlYWRlciIsInVzZXJfYWdlbnQiLCJnZXQiLCJ1cmwiLCJfZGVidWciLCJzZWxmX3BhdGgiLCJib2R5UGFyc2VyIiwianNvbiIsInN0cmljdCIsImxpbWl0IiwibWF4X2JvZHlfc2l6ZSIsInBsdWdpbl9wYXJhbXMiLCJsb2dnZXIiLCJwbHVnaW5zIiwibWlkZGxld2FyZXMiLCJwbHVnaW4iLCJyZWdpc3Rlcl9taWRkbGV3YXJlcyIsImZvckVhY2giLCJfIiwiRXJyb3JDb2RlIiwiZ2V0Tm90Rm91bmQiLCJBUElfRVJST1IiLCJXRUJfRElTQUJMRUQiLCJGSUxFX05PVF9GT1VORCIsImVyciIsImlzRXJyb3IiLCJjb2RlIiwic3RhdHVzQ29kZSIsIkhUVFBfU1RBVFVTIiwiTk9UX01PRElGSUVEIiwiaXNGdW5jdGlvbiIsInJlcG9ydF9lcnJvciIsIm5vb3AiLCJmaW5hbCIsImNvbmZpZ0hhc2giLCJsb2dzIiwiQXBwQ29uZmlnIiwiY2xvbmVEZWVwIiwiZmlsdGVycyIsImZpbHRlcl9tZXRhZGF0YSIsIlN0b3JhZ2UiLCJpbml0Il0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0E7O0FBQ0E7Ozs7QUFFQSxNQUFNQSxTQUFTLEdBQUcsVUFBU0MsTUFBVCxFQUEwQkMsT0FBMUIsRUFBeUQ7QUFDekUsUUFBTUMsSUFBVyxHQUFHLElBQUlDLGFBQUosQ0FBU0gsTUFBVCxDQUFwQjtB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QSxNQUFNLEVBQUVBLE1BRFk7QUFFcEIyQixJQUFBQSxNQUFNLEVBQUVBO0FBRlksR0FBdEI7QUFJQSxRQUFNMEIsT0FBTyxHQUFHLDJCQUFXckQsTUFBWCxFQUFtQkEsTUFBTSxDQUFDcUQsT0FBUCxJQUFrQixFQUFyQyxFQUF5QzNCLGFBQXpDLEVBQXlESSxNQUFELElBQTJDQSxNQUFNLENBQUN3QixlQUExRyxDQUFoQjtBQUNBLFFBQU1yRCxPQUF3QixHQUFHLElBQUlzRCxnQkFBSixDQUFZdkQsTUFBWixDQUFqQyxDQVQ0RCxDQVU1RDs7QUFDQSxRQUFNQyxPQUFPLENBQUN1RCxJQUFSLENBQWF4RCxNQUFiLEVBQXFCcUQsT0FBckIsQ0FBTjtBQUNBLFNBQU90RCxTQUFTLENBQUNDLE1BQUQsRUFBU0MsT0FBVCxDQUFoQjtBQUNELEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGV4cHJlc3MsIHsgQXBwbGljYXRpb24gfSBmcm9tICdleHByZXNzJztcbmltcG9ydCBib2R5UGFyc2VyIGZyb20gJ2JvZHktcGFyc2VyJztcbmltcG9ydCBjb21wcmVzc2lvbiBmcm9tICdjb21wcmVzc2lvbic7XG5pbXBvcnQgY29ycyBmcm9tICdjb3JzJztcbmltcG9ydCB7IEh0dHBFcnJvciB9IGZyb20gJ2h0dHAtZXJyb3JzJztcbmltcG9ydCBTdG9yYWdlIGZyb20gJy4uL2xpYi9zdG9yYWdlJztcbmltcG9ydCBsb2FkUGx1Z2luIGZyb20gJy4uL2xpYi9wbHVnaW4tbG9hZGVyJztcbmltcG9ydCBob29rRGVidWcgZnJvbSAnLi9kZWJ1Zyc7XG5pbXBvcnQgQXV0aCBmcm9tICcuLi9saWIvYXV0aCc7XG5pbXBvcnQgYXBpRW5kcG9pbnQgZnJvbSAnLi9lbmRwb2ludCc7XG5pbXBvcnQgeyBFcnJvckNvZGUgfSBmcm9tICcuLi9saWIvdXRpbHMnO1xuaW1wb3J0IHsgQVBJX0VSUk9SLCBIVFRQX1NUQVRVUyB9IGZyb20gJy4uL2xpYi9jb25zdGFudHMnO1xuaW1wb3J0IEFwcENvbmZpZyBmcm9tICcuLi9saWIvY29uZmlnJztcbmltcG9ydCB3ZWJBUEkgZnJvbSAnLi93ZWIvYXBpJztcbmltcG9ydCB3ZWIgZnJvbSAnLi93ZWInO1xuaW1wb3J0IHsgJFJlc3BvbnNlRXh0ZW5kLCAkUmVxdWVzdEV4dGVuZCwgJE5leHRGdW5jdGlvblZlciwgSVN0b3JhZ2VIYW5kbGVyLCBJQXV0aCB9IGZyb20gJy4uLy4uL3R5cGVzJztcbmltcG9ydCB7IENvbmZpZyBhcyBJQ29uZmlnLCBJUGx1Z2luTWlkZGxld2FyZSwgSVBsdWdpblN0b3JhZ2VGaWx0ZXIgfSBmcm9tICdAdmVyZGFjY2lvL3R5cGVzJztcbmltcG9ydCB7IHNldHVwLCBsb2dnZXIgfSBmcm9tICcuLi9saWIvbG9nZ2VyJztcbmltcG9ydCB7IGxvZywgZmluYWwsIGVycm9yUmVwb3J0aW5nTWlkZGxld2FyZSB9IGZyb20gJy4vbWlkZGxld2FyZSc7XG5cbmNvbnN0IGRlZmluZUFQSSA9IGZ1bmN0aW9uKGNvbmZpZzogSUNvbmZpZywgc3RvcmFnZTogSVN0b3JhZ2VIYW5kbGVyKTogYW55IHtcbiAgY29uc3QgYXV0aDogSUF1dGggPSBuZXcgQXV0aChjb25maWcpO1xuICBjb25zdCBhcHA6IEFwcGxpY2F0aW9uID0gZXhwcmVzcygpO1xuICAvLyBydW4gaW4gcHJvZHVjdGlvbiBtb2RlIGJ5IGRlZmF1bHQsIGp1c3QgaW4gY2FzZVxuICAvLyBpdCBzaG91bGRuJ3QgbWFrZSBhbnkgZGlmZmVyZW5jZSBhbnl3YXlcbiAgYXBwLnNldCgnZW52JywgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgfHwgJ3Byb2R1Y3Rpb24nKTtcbiAgYXBwLnVzZShjb3JzKCkpO1xuXG4gIC8vIFJvdXRlciBzZXR1cFxuICBhcHAudXNlKGxvZyk7XG4gIGFwcC51c2UoZXJyb3JSZXBvcnRpbmdNaWRkbGV3YXJlKTtcbiAgYXBwLnVzZShmdW5jdGlvbihyZXE6ICRSZXF1ZXN0RXh0ZW5kLCByZXM6ICRSZXNwb25zZUV4dGVuZCwgbmV4dDogJE5leHRGdW5jdGlvblZlcik6IHZvaWQge1xuICAgIHJlcy5zZXRIZWFkZXIoJ1gtUG93ZXJlZC1CeScsIGNvbmZpZy51c2VyX2FnZW50KTtcbiAgICBuZXh0KCk7XG4gIH0pO1xuXG4gIGFwcC51c2UoY29tcHJlc3Npb24oKSk7XG5cbiAgYXBwLmdldCgnL2Zhdmljb24uaWNvJywgZnVuY3Rpb24ocmVxOiAkUmVxdWVzdEV4dGVuZCwgcmVzOiAkUmVzcG9uc2VFeHRlbmQsIG5leHQ6ICROZXh0RnVuY3Rpb25WZXIpOiB2b2lkIHtcbiAgICByZXEudXJsID0gJy8tL3N0YXRpYy9mYXZpY29uLnBuZyc7XG4gICAgbmV4dCgpO1xuICB9KTtcblxuICAvLyBIb29rIGZvciB0ZXN0cyBvbmx5XG4gIGlmIChjb25maWcuX2RlYnVnKSB7XG4gICAgaG9va0RlYnVnKGFwcCwgY29uZmlnLnNlbGZfcGF0aCk7XG4gIH1cblxuICBhcHAudXNlKGJvZHlQYXJzZXIuanNvbih7IHN0cmljdDogZmFsc2UsIGxpbWl0OiBjb25maWcubWF4X2JvZHlfc2l6ZSB8fCAnMTBtYicgfSkpO1xuXG4gIC8vIHJlZ2lzdGVyIG1pZGRsZXdhcmUgcGx1Z2luc1xuICBjb25zdCBwbHVnaW5fcGFyYW1zID0ge1xuICAgIGNvbmZpZzogY29uZmlnLFxuICAgIGxvZ2dlcjogbG9nZ2VyLFxuICB9O1xuXG4gIGNvbnN0IHBsdWdpbnM6IElQbHVnaW5NaWRkbGV3YXJlPElDb25maWc+W10gPSBsb2FkUGx1Z2luKGNvbmZpZywgY29uZmlnLm1pZGRsZXdhcmVzLCBwbHVnaW5fcGFyYW1zLCBmdW5jdGlvbihwbHVnaW46IElQbHVnaW5NaWRkbGV3YXJlPElDb25maWc+KSB7XG4gICAgcmV0dXJuIHBsdWdpbi5yZWdpc3Rlcl9taWRkbGV3YXJlcztcbiAgfSk7XG4gIHBsdWdpbnMuZm9yRWFjaCgocGx1Z2luOiBJUGx1Z2luTWlkZGxld2FyZTxJQ29uZmlnPikgPT4ge1xuICAgIHBsdWdpbi5yZWdpc3Rlcl9taWRkbGV3YXJlcyhhcHAsIGF1dGgsIHN0b3JhZ2UpO1xuICB9KTtcblxuICAvLyBGb3IgIG5wbSByZXF1ZXN0XG4gIGFwcC51c2UoYXBpRW5kcG9pbnQoY29uZmlnLCBhdXRoLCBzdG9yYWdlKSk7XG5cbiAgLy8gRm9yIFdlYlVJICYgV2ViVUkgQVBJXG4gIGlmIChfLmdldChjb25maWcsICd3ZWIuZW5hYmxlJywgdHJ1ZSkpIHtcbiAgICBhcHAudXNlKCcvJywgd2ViKGNvbmZpZywgYXV0aCwgc3RvcmFnZSkpO1xuICAgIGFwcC51c2UoJy8tL3ZlcmRhY2Npby8nLCB3ZWJBUEkoY29uZmlnLCBhdXRoLCBzdG9yYWdlKSk7XG4gIH0gZWxzZSB7XG4gICAgYXBwLmdldCgnLycsIGZ1bmN0aW9uKHJlcTogJFJlcXVlc3RFeHRlbmQsIHJlczogJFJlc3BvbnNlRXh0ZW5kLCBuZXh0OiAkTmV4dEZ1bmN0aW9uVmVyKSB7XG4gICAgICBuZXh0KEVycm9yQ29kZS5nZXROb3RGb3VuZChBUElfRVJST1IuV0VCX0RJU0FCTEVEKSk7XG4gICAgfSk7XG4gIH1cblxuICAvLyBDYXRjaCA0MDRcbiAgYXBwLmdldCgnLyonLCBmdW5jdGlvbihyZXE6ICRSZXF1ZXN0RXh0ZW5kLCByZXM6ICRSZXNwb25zZUV4dGVuZCwgbmV4dDogJE5leHRGdW5jdGlvblZlcikge1xuICAgIG5leHQoRXJyb3JDb2RlLmdldE5vdEZvdW5kKEFQSV9FUlJPUi5GSUxFX05PVF9GT1VORCkpO1xuICB9KTtcblxuICBhcHAudXNlKGZ1bmN0aW9uKGVycjogSHR0cEVycm9yLCByZXE6ICRSZXF1ZXN0RXh0ZW5kLCByZXM6ICRSZXNwb25zZUV4dGVuZCwgbmV4dDogJE5leHRGdW5jdGlvblZlcikge1xuICAgIGlmIChfLmlzRXJyb3IoZXJyKSkge1xuICAgICAgaWYgKGVyci5jb2RlID09PSAnRUNPTk5BQk9SVCcgJiYgcmVzLnN0YXR1c0NvZGUgPT09IEhUVFBfU1RBVFVTLk5PVF9NT0RJRklFRCkge1xuICAgICAgICByZXR1cm4gbmV4dCgpO1xuICAgICAgfVxuICAgICAgaWYgKF8uaXNGdW5jdGlvbihyZXMucmVwb3J0X2Vycm9yKSA9PT0gZmFsc2UpIHtcbiAgICAgICAgLy8gaW4gY2FzZSBvZiB2ZXJ5IGVhcmx5IGVycm9yIHRoaXMgbWlkZGxld2FyZSBtYXkgbm90IGJlIGxvYWRlZCBiZWZvcmUgZXJyb3IgaXMgZ2VuZXJhdGVkXG4gICAgICAgIC8vIGZpeGluZyB0aGF0XG4gICAgICAgIGVycm9yUmVwb3J0aW5nTWlkZGxld2FyZShyZXEsIHJlcywgXy5ub29wKTtcbiAgICAgIH1cbiAgICAgIHJlcy5yZXBvcnRfZXJyb3IoZXJyKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gRmFsbCB0byBNaWRkbGV3YXJlLmZpbmFsXG4gICAgICByZXR1cm4gbmV4dChlcnIpO1xuICAgIH1cbiAgfSk7XG5cbiAgYXBwLnVzZShmaW5hbCk7XG5cbiAgcmV0dXJuIGFwcDtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IChhc3luYyBmdW5jdGlvbihjb25maWdIYXNoOiBhbnkpOiBQcm9taXNlPGFueT4ge1xuICBzZXR1cChjb25maWdIYXNoLmxvZ3MpO1xuICBjb25zdCBjb25maWc6IElDb25maWcgPSBuZXcgQXBwQ29uZmlnKF8uY2xvbmVEZWVwKGNvbmZpZ0hhc2gpKTtcbiAgLy8gcmVnaXN0ZXIgbWlkZGxld2FyZSBwbHVnaW5zXG4gIGNvbnN0IHBsdWdpbl9wYXJhbXMgPSB7XG4gICAgY29uZmlnOiBjb25maWcsXG4gICAgbG9nZ2VyOiBsb2dnZXIsXG4gIH07XG4gIGNvbnN0IGZpbHRlcnMgPSBsb2FkUGx1Z2luKGNvbmZpZywgY29uZmlnLmZpbHRlcnMgfHwge30sIHBsdWdpbl9wYXJhbXMsIChwbHVnaW46IElQbHVnaW5TdG9yYWdlRmlsdGVyPElDb25maWc+KSA9PiBwbHVnaW4uZmlsdGVyX21ldGFkYXRhKTtcbiAgY29uc3Qgc3RvcmFnZTogSVN0b3JhZ2VIYW5kbGVyID0gbmV3IFN0b3JhZ2UoY29uZmlnKTtcbiAgLy8gd2FpdHMgdW50aWwgaW5pdCBjYWxscyBoYXZlIGJlZW4gaW5pdGlhbGl6ZWRcbiAgYXdhaXQgc3RvcmFnZS5pbml0KGNvbmZpZywgZmlsdGVycyk7XG4gIHJldHVybiBkZWZpbmVBUEkoY29uZmlnLCBzdG9yYWdlKTtcbn0pO1xuIl19