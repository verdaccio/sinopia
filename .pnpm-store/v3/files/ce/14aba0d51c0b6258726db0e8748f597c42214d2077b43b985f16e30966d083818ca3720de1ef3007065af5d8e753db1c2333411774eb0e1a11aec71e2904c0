"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.setup = setup;
exports.logger = void 0;

var _prettyTimestamped = require("./logger/format/pretty-timestamped");

var _pretty = require("./logger/format/pretty");

var _json = require("./logger/format/json");

/* eslint-disable */
const cluster = require('cluster');

const Logger = require('bunyan');

const Error = require('http-errors');

const Stream = require('stream');

const pkgJSON = require('../../package.json');

const _ = require('lodash');

const dayjs = require('dayjs');
/**
 * A RotatingFileStream that modifies the message first
 */


class VerdaccioRotatingFileStream extends Logger.RotatingFileStream {
  // We depend on mv so that this is there
  write(obj) {
    super.write((0, _json.jsonFormat)(obj, false));
  }

  rotate() {
    super.rotate();
    this.emit('rotated');
  }

}

let logger;
exports.logger = logger;
const DEFAULT_LOGGER_CONF = [{
  type: 'stdout',
  format: 'pretty',
  level: 'http'
}];
/**
 * Setup the Buyan logger
 * @param {*} logs list of log configuration
 */

function setup(logs, {
  logStart
} = {
  logStart: true
}) {
  const streams = [];

  if (logs == null) {
    logs = DEFAULT_LOGGER_CONF;
  }

  logs.forEach(function (target) {
    let level = target.level || 35;

    if (level === 'http') {
      level = 35;
    } // create a stream for each log configuration


    if (target.type === 'rotating-file') {
      if (target.format !== 'json') {
        throw new Error('Rotating file streams only work with JSON!');
      }

      if (cluster.isWorker) {
        // https://github.com/trentm/node-bunyan#stream-type-rotating-file
        throw new Error('Cluster mode is not supported for rotating-file!');
      }

      const stream = new VerdaccioRotatingFileStream( // @ts-ignore
      _.merge({}, // Defaults can be found here: https://github.com/trentm/node-bunyan#stream-type-rotating-file
      target.options || {}, {
        path: target.path,
        level
      }));
      const rotateStream = {
        type: 'raw',
        level,
        stream
      };

      if (logStart) {
        stream.on('rotated', () => logger.warn('Start of logfile'));
      }

      streams.push(rotateStream);
    } else {
      const stream = new Stream();
      stream.writable = true;
      let destination;
      let destinationIsTTY = false;

      if (target.type === 'file') {
        // destination stream
        destination = require('fs').createWriteStream(target.path, {
          flags: 'a',
          encoding: 'utf8'
        });
        destination.on('error', function (err) {
          stream.emit('error', err);
        });
      } else if (target.type === 'stdout' || target.type === 'stderr') {
        destination = target.type === 'stdout' ? process.stdout : process.stderr;
        destinationIsTTY = destination.isTTY;
      } else {
        throw Error('wrong target type for a log');
      }

      if (target.format === 'pretty') {
        // making fake stream for pretty printing
        stream.write = obj => {
          destination.write((0, _pretty.pretty)(obj, destinationIsTTY));
        };
      } else if (target.format === 'pretty-timestamped') {
        // making fake stream for pretty printing
        stream.write = obj => {
          destination.write((0, _prettyTimestamped.prettyTimestamped)(obj, destinationIsTTY));
        };
      } else {
        stream.write = obj => {
          destination.write((0, _json.jsonFormat)(obj, destinationIsTTY));
        };
      }

      streams.push({
        // @ts-ignore
        type: 'raw',
        // @ts-ignore
        level,
        // @ts-ignore
        stream: stream
      });
    }
  }); // buyan default configuration

  exports.logger = logger = new Logger({
    name: pkgJSON.name,
    streams: streams,
    serializers: {
      err: Logger.stdSerializers.err,
      req: Logger.stdSerializers.req,
      res: Logger.stdSerializers.res
    }
  }); // In case of an empty log file, we ensure there is always something logged. This also helps see if the server
  // was restarted in any cases

  if (logStart) {
    logger.warn('Verdaccio started');
  }

  process.on('SIGUSR2', function () {
    Logger.reopenFileStreams();
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvbG9nZ2VyLnRzIl0sIm5hbWVzIjpbImNsdXN0ZXIiLCJyZXF1aXJlIiwiTG9nZ2VyIiwiRXJyb3IiLCJTdHJlYW0iLCJwa2dKU09OIiwiXyIsImRheWpzIiwiVmVyZGFjY2lvUm90YXRpbmdGaWxlU3RyZWFtIiwiUm90YXRpbmdGaWxlU3RyZWFtIiwid3JpdGUiLCJvYmoiLCJyb3RhdGUiLCJlbWl0IiwibG9nZ2VyIiwiREVGQVVMVF9MT0dHRVJfQ09ORiIsInR5cGUiLCJmb3JtYXQiLCJsZXZlbCIsInNldHVwIiwibG9ncyIsImxvZ1N0YXJ0Iiwic3RyZWFtcyIsImZvckVhY2giLCJ0YXJnZXQiLCJpc1dvcmtlciIsInN0cmVhbSIsIm1lcmdlIiwib3B0aW9ucyIsInBhdGgiLCJyb3RhdGVTdHJlYW0iLCJvbiIsIndhcm4iLCJwdXNoIiwid3JpdGFibGUiLCJkZXN0aW5hdGlvbiIsImRlc3RpbmF0aW9uSXNUVFkiLCJjcmVhdGVXcml0ZVN0cmVhbSIsImZsYWdzIiwiZW5jb2RpbmciLCJlcnIiLCJwcm9jZXNzIiwic3Rkb3V0Iiwic3RkZXJyIiwiaXNUVFkiLCJuYW1lIiwic2VyaWFsaXplcnMiLCJzdGRTZXJpYWxpemVycyIsInJlcSIsInJlcyIsInJlb3BlbkZpbGVTdHJlYW1zIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUVBOztBQUNBOztBQUNBOztBQUpBO0FBTUEsTUFBTUEsT0FBTyxHQUFHQyxPQUFPLENBQUMsU0FBRCxDQUF2Qjs7QUFDQSxNQUFNQyxNQUFNLEdBQUdELE9BQU8sQ0FBQyxRQUFELENBQXRCOztBQUNBLE1BQU1FLEtBQUssR0FBR0YsT0FBTyxDQUFDLGFBQUQsQ0FBckI7O0FBQ0EsTUFBTUcsTUFBTSxHQUFHSCxPQUFPLENBQUMsUUFBRCxDQUF0Qjs7QUFDQSxNQUFNSSxPQUFPLEdBQUdKLE9BQU8sQ0FBQyxvQkFBRCxDQUF2Qjs7QUFDQSxNQUFNSyxDQUFDLEdBQUdMLE9BQU8sQ0FBQyxRQUFELENBQWpC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eUIsZ0JBQWhCLENBQWxCO0FBQ0QsU0FGRDtBQUdEOztBQUVEZCxNQUFBQSxPQUFPLENBQUNXLElBQVIsQ0FBYTtBQUNYO0FBQ0FqQixRQUFBQSxJQUFJLEVBQUUsS0FGSztBQUdYO0FBQ0FFLFFBQUFBLEtBSlc7QUFLWDtBQUNBUSxRQUFBQSxNQUFNLEVBQUVBO0FBTkcsT0FBYjtBQVFEO0FBQ0YsR0FqRkQsRUFOc0QsQ0F5RnREOztBQUNBLG1CQUFBWixNQUFNLEdBQUcsSUFBSVosTUFBSixDQUFXO0FBQ2xCMkMsSUFBQUEsSUFBSSxFQUFFeEMsT0FBTyxDQUFDd0MsSUFESTtBQUVsQnZCLElBQUFBLE9BQU8sRUFBRUEsT0FGUztBQUdsQndCLElBQUFBLFdBQVcsRUFBRTtBQUNYTixNQUFBQSxHQUFHLEVBQUV0QyxNQUFNLENBQUM2QyxjQUFQLENBQXNCUCxHQURoQjtBQUVYUSxNQUFBQSxHQUFHLEVBQUU5QyxNQUFNLENBQUM2QyxjQUFQLENBQXNCQyxHQUZoQjtBQUdYQyxNQUFBQSxHQUFHLEVBQUUvQyxNQUFNLENBQUM2QyxjQUFQLENBQXNCRTtBQUhoQjtBQUhLLEdBQVgsQ0FBVCxDQTFGc0QsQ0FvR3REO0FBQ0E7O0FBQ0EsTUFBSTVCLFFBQUosRUFBYztBQUNaUCxJQUFBQSxNQUFNLENBQUNrQixJQUFQLENBQVksbUJBQVo7QUFDRDs7QUFFRFMsRUFBQUEsT0FBTyxDQUFDVixFQUFSLENBQVcsU0FBWCxFQUFzQixZQUFXO0FBQy9CN0IsSUFBQUEsTUFBTSxDQUFDZ0QsaUJBQVA7QUFDRCxHQUZEO0FBR0QiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSAqL1xuXG5pbXBvcnQge3ByZXR0eVRpbWVzdGFtcGVkfSBmcm9tIFwiLi9sb2dnZXIvZm9ybWF0L3ByZXR0eS10aW1lc3RhbXBlZFwiO1xuaW1wb3J0IHtwcmV0dHl9IGZyb20gXCIuL2xvZ2dlci9mb3JtYXQvcHJldHR5XCI7XG5pbXBvcnQge2pzb25Gb3JtYXR9IGZyb20gXCIuL2xvZ2dlci9mb3JtYXQvanNvblwiO1xuXG5jb25zdCBjbHVzdGVyID0gcmVxdWlyZSgnY2x1c3RlcicpO1xuY29uc3QgTG9nZ2VyID0gcmVxdWlyZSgnYnVueWFuJyk7XG5jb25zdCBFcnJvciA9IHJlcXVpcmUoJ2h0dHAtZXJyb3JzJyk7XG5jb25zdCBTdHJlYW0gPSByZXF1aXJlKCdzdHJlYW0nKTtcbmNvbnN0IHBrZ0pTT04gPSByZXF1aXJlKCcuLi8uLi9wYWNrYWdlLmpzb24nKTtcbmNvbnN0IF8gPSByZXF1aXJlKCdsb2Rhc2gnKTtcbmNvbnN0IGRheWpzID0gcmVxdWlyZSgnZGF5anMnKTtcblxuLyoqXG4gKiBBIFJvdGF0aW5nRmlsZVN0cmVhbSB0aGF0IG1vZGlmaWVzIHRoZSBtZXNzYWdlIGZpcnN0XG4gKi9cbmNsYXNzIFZlcmRhY2Npb1JvdGF0aW5nRmlsZVN0cmVhbSBleHRlbmRzIExvZ2dlci5Sb3RhdGluZ0ZpbGVTdHJlYW0ge1xuICAvLyBXZSBkZXBlbmQgb24gbXYgc28gdGhhdCB0aGlzIGlzIHRoZXJlXG4gIHdyaXRlKG9iaikge1xuICAgIHN1cGVyLndyaXRlKGpzb25Gb3JtYXQob2JqLCBmYWxzZSkpO1xuICB9XG5cbiAgcm90YXRlKCk6IHZvaWQge1xuICAgIHN1cGVyLnJvdGF0ZSgpO1xuICAgIHRoaXMuZW1pdCgncm90YXRlZCcpO1xuICB9XG59XG5cbmxldCBsb2dnZXI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgTG9nZ2VyVGFyZ2V0IHtcbiAgdHlwZT86IHN0cmluZztcbiAgZm9ybWF0Pzogc3RyaW5nO1xuICBsZXZlbD86IHN0cmluZztcbiAgb3B0aW9ucz86IGFueTtcbiAgcGF0aD86IHN0cmluZztcbn1cblxuY29uc3QgREVGQVVMVF9MT0dHRVJfQ09ORiA9IFt7IHR5cGU6ICdzdGRvdXQnLCBmb3JtYXQ6ICdwcmV0dHknLCBsZXZlbDogJ2h0dHAnIH1dO1xuXG4vKipcbiAqIFNldHVwIHRoZSBCdXlhbiBsb2dnZXJcbiAqIEBwYXJhbSB7Kn0gbG9ncyBsaXN0IG9mIGxvZyBjb25maWd1cmF0aW9uXG4gKi9cbmZ1bmN0aW9uIHNldHVwKGxvZ3MsIHsgbG9nU3RhcnQgfSA9IHsgbG9nU3RhcnQ6IHRydWUgfSkge1xuICBjb25zdCBzdHJlYW1zOiBhbnkgPSBbXTtcbiAgaWYgKGxvZ3MgPT0gbnVsbCkge1xuICAgIGxvZ3MgPSBERUZBVUxUX0xPR0dFUl9DT05GO1xuICB9XG5cbiAgbG9ncy5mb3JFYWNoKGZ1bmN0aW9uKHRhcmdldDogTG9nZ2VyVGFyZ2V0KSB7XG4gICAgbGV0IGxldmVsID0gdGFyZ2V0LmxldmVsIHx8IDM1O1xuICAgIGlmIChsZXZlbCA9PT0gJ2h0dHAnKSB7XG4gICAgICBsZXZlbCA9IDM1O1xuICAgIH1cblxuICAgIC8vIGNyZWF0ZSBhIHN0cmVhbSBmb3IgZWFjaCBsb2cgY29uZmlndXJhdGlvblxuICAgIGlmICh0YXJnZXQudHlwZSA9PT0gJ3JvdGF0aW5nLWZpbGUnKSB7XG4gICAgICBpZiAodGFyZ2V0LmZvcm1hdCAhPT0gJ2pzb24nKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignUm90YXRpbmcgZmlsZSBzdHJlYW1zIG9ubHkgd29yayB3aXRoIEpTT04hJyk7XG4gICAgICB9XG4gICAgICBpZiAoY2x1c3Rlci5pc1dvcmtlcikge1xuICAgICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vdHJlbnRtL25vZGUtYnVueWFuI3N0cmVhbS10eXBlLXJvdGF0aW5nLWZpbGVcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDbHVzdGVyIG1vZGUgaXMgbm90IHN1cHBvcnRlZCBmb3Igcm90YXRpbmctZmlsZSEnKTtcbiAgICAgIH1cblxuICAgICAgY29uc3Qgc3RyZWFtID0gbmV3IFZlcmRhY2Npb1JvdGF0aW5nRmlsZVN0cmVhbShcbiAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICBfLm1lcmdlKFxuICAgICAgICAgIHt9LFxuICAgICAgICAgIC8vIERlZmF1bHRzIGNhbiBiZSBmb3VuZCBoZXJlOiBodHRwczovL2dpdGh1Yi5jb20vdHJlbnRtL25vZGUtYnVueWFuI3N0cmVhbS10eXBlLXJvdGF0aW5nLWZpbGVcbiAgICAgICAgICB0YXJnZXQub3B0aW9ucyB8fCB7fSxcbiAgICAgICAgICB7IHBhdGg6IHRhcmdldC5wYXRoLCBsZXZlbCB9XG4gICAgICAgIClcbiAgICAgICk7XG5cbiAgICAgIGNvbnN0IHJvdGF0ZVN0cmVhbSA9IHtcbiAgICAgICAgdHlwZTogJ3JhdycsXG4gICAgICAgIGxldmVsLFxuICAgICAgICBzdHJlYW0sXG4gICAgICB9O1xuXG4gICAgICBpZiAobG9nU3RhcnQpIHtcbiAgICAgICAgc3RyZWFtLm9uKCdyb3RhdGVkJywgKCkgPT4gbG9nZ2VyLndhcm4oJ1N0YXJ0IG9mIGxvZ2ZpbGUnKSk7XG4gICAgICB9XG5cbiAgICAgIHN0cmVhbXMucHVzaChyb3RhdGVTdHJlYW0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBzdHJlYW0gPSBuZXcgU3RyZWFtKCk7XG4gICAgICBzdHJlYW0ud3JpdGFibGUgPSB0cnVlO1xuXG4gICAgICBsZXQgZGVzdGluYXRpb247XG4gICAgICBsZXQgZGVzdGluYXRpb25Jc1RUWSA9IGZhbHNlO1xuICAgICAgaWYgKHRhcmdldC50eXBlID09PSAnZmlsZScpIHtcbiAgICAgICAgLy8gZGVzdGluYXRpb24gc3RyZWFtXG4gICAgICAgIGRlc3RpbmF0aW9uID0gcmVxdWlyZSgnZnMnKS5jcmVhdGVXcml0ZVN0cmVhbSh0YXJnZXQucGF0aCwgeyBmbGFnczogJ2EnLCBlbmNvZGluZzogJ3V0ZjgnIH0pO1xuICAgICAgICBkZXN0aW5hdGlvbi5vbignZXJyb3InLCBmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgICBzdHJlYW0uZW1pdCgnZXJyb3InLCBlcnIpO1xuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSBpZiAodGFyZ2V0LnR5cGUgPT09ICdzdGRvdXQnIHx8IHRhcmdldC50eXBlID09PSAnc3RkZXJyJykge1xuICAgICAgICBkZXN0aW5hdGlvbiA9IHRhcmdldC50eXBlID09PSAnc3Rkb3V0JyA/IHByb2Nlc3Muc3Rkb3V0IDogcHJvY2Vzcy5zdGRlcnI7XG4gICAgICAgIGRlc3RpbmF0aW9uSXNUVFkgPSBkZXN0aW5hdGlvbi5pc1RUWTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IEVycm9yKCd3cm9uZyB0YXJnZXQgdHlwZSBmb3IgYSBsb2cnKTtcbiAgICAgIH1cblxuICAgICAgaWYgKHRhcmdldC5mb3JtYXQgPT09ICdwcmV0dHknKSB7XG4gICAgICAgIC8vIG1ha2luZyBmYWtlIHN0cmVhbSBmb3IgcHJldHR5IHByaW50aW5nXG4gICAgICAgIHN0cmVhbS53cml0ZSA9IG9iaiA9PiB7XG4gICAgICAgICAgZGVzdGluYXRpb24ud3JpdGUocHJldHR5KG9iaiwgZGVzdGluYXRpb25Jc1RUWSkpO1xuICAgICAgICB9O1xuICAgICAgfSBlbHNlIGlmICh0YXJnZXQuZm9ybWF0ID09PSAncHJldHR5LXRpbWVzdGFtcGVkJykge1xuICAgICAgICAvLyBtYWtpbmcgZmFrZSBzdHJlYW0gZm9yIHByZXR0eSBwcmludGluZ1xuICAgICAgICBzdHJlYW0ud3JpdGUgPSBvYmogPT4ge1xuICAgICAgICAgIGRlc3RpbmF0aW9uLndyaXRlKHByZXR0eVRpbWVzdGFtcGVkKG9iaiwgZGVzdGluYXRpb25Jc1RUWSkpO1xuICAgICAgICB9O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgc3RyZWFtLndyaXRlID0gb2JqID0+IHtcbiAgICAgICAgICBkZXN0aW5hdGlvbi53cml0ZShqc29uRm9ybWF0KG9iaiwgZGVzdGluYXRpb25Jc1RUWSkpO1xuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICBzdHJlYW1zLnB1c2goe1xuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIHR5cGU6ICdyYXcnLFxuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIGxldmVsLFxuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIHN0cmVhbTogc3RyZWFtLFxuICAgICAgfSk7XG4gICAgfVxuICB9KTtcblxuICAvLyBidXlhbiBkZWZhdWx0IGNvbmZpZ3VyYXRpb25cbiAgbG9nZ2VyID0gbmV3IExvZ2dlcih7XG4gICAgbmFtZTogcGtnSlNPTi5uYW1lLFxuICAgIHN0cmVhbXM6IHN0cmVhbXMsXG4gICAgc2VyaWFsaXplcnM6IHtcbiAgICAgIGVycjogTG9nZ2VyLnN0ZFNlcmlhbGl6ZXJzLmVycixcbiAgICAgIHJlcTogTG9nZ2VyLnN0ZFNlcmlhbGl6ZXJzLnJlcSxcbiAgICAgIHJlczogTG9nZ2VyLnN0ZFNlcmlhbGl6ZXJzLnJlcyxcbiAgICB9LFxuICB9KTtcblxuICAvLyBJbiBjYXNlIG9mIGFuIGVtcHR5IGxvZyBmaWxlLCB3ZSBlbnN1cmUgdGhlcmUgaXMgYWx3YXlzIHNvbWV0aGluZyBsb2dnZWQuIFRoaXMgYWxzbyBoZWxwcyBzZWUgaWYgdGhlIHNlcnZlclxuICAvLyB3YXMgcmVzdGFydGVkIGluIGFueSBjYXNlc1xuICBpZiAobG9nU3RhcnQpIHtcbiAgICBsb2dnZXIud2FybignVmVyZGFjY2lvIHN0YXJ0ZWQnKTtcbiAgfVxuXG4gIHByb2Nlc3Mub24oJ1NJR1VTUjInLCBmdW5jdGlvbigpIHtcbiAgICBMb2dnZXIucmVvcGVuRmlsZVN0cmVhbXMoKTtcbiAgfSk7XG59XG5cbmV4cG9ydCB7IHNldHVwLCBsb2dnZXIgfTtcbiJdfQ==