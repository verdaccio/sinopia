"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.generatePackageTemplate = generatePackageTemplate;
exports.normalizePackage = normalizePackage;
exports.generateRevision = generateRevision;
exports.getLatestReadme = getLatestReadme;
exports.cleanUpReadme = cleanUpReadme;
exports.normalizeContributors = normalizeContributors;
exports.cleanUpLinksRef = cleanUpLinksRef;
exports.checkPackageLocal = checkPackageLocal;
exports.publishPackage = publishPackage;
exports.checkPackageRemote = checkPackageRemote;
exports.mergeUplinkTimeIntoLocal = mergeUplinkTimeIntoLocal;
exports.prepareSearchPackage = prepareSearchPackage;
exports.isPublishablePackage = isPublishablePackage;
exports.WHITELIST = void 0;

var _lodash = _interopRequireDefault(require("lodash"));

var _utils = require("./utils");

var _search = _interopRequireDefault(require("./search"));

var _cryptoUtils = require("../lib/crypto-utils");

var _constants = require("./constants");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function generatePackageTemplate(name) {
  return {
    // standard things
    name,
    versions: {},
    time: {},
    [_constants.USERS]: {},
    [_constants.DIST_TAGS]: {},
    _uplinks: {},
    _distfiles: {},
    _attachments: {},
    _rev: ''
  };
}
/**
 * Normalize package properties, tags, revision id.
 * @param {Object} pkg package reference.
 */


function normalizePackage(pkg) {
  const pkgProperties = ['versions', 'dist-tags', '_distfiles', '_attachments', '_uplinks', 'time'];
  pkgProperties.forEach(key => {
    const pkgProp = pkg[key];

    if (_lodash.default.isNil(pkgProp) || (0, _utils.isObject)(pkgProp) === false) {
      pkg[key] = {};
    }
  });

  if (_lodash.default.isString(pkg._rev) === false) {
    pkg._rev = _constants.STORAGE.DEFAULT_REVISION;
  }

  if (_lodash.default.isString(pkg._id) === false) {
    pkg._id = pkg.name;
  } // normalize dist-tags


  (0, _utils.normalizeDistTags)(pkg);
  return pkg;
}

function generateRevision(rev) {
  const _rev = rev.split('-');

  return (+_rev[0] || 0) + 1 + '-' + (0, _cryptoUtils.generateRandomHexString)();
}

function getLatestReadme(pkg) {
  const versions = pkg['versions'] || {};
  const distTags = pkg[_constants.DIST_TAGS] || {}; // FIXME: here is a bit tricky add the types

  const latestVersion = distTags['latest'] ? versions[distTags['latest']] || {} : {};

  let readme = _lodash.default.trim(pkg.readme || latestVersion.readme || '');

  if (readme) {
    return readme;
  } // In case of empty readme - trying to get ANY readme in the following order: 'next','beta','alpha','test','dev','canary'


  const readmeDistTagsPriority = ['next', 'beta', 'alpha', 'test', 'dev', 'canary'];
  readmeDistTagsPriority.map(function (tag) {
    if (readme) {
      return readme;
    }

    const version = distTags[tag] ? versions[distTags[tag]] || {} : {};
    readme = _lodash.default.trim(version.readme || readme);
  });
  return readme;
}

function cleanUpReadme(version) {
  if (_lodash.default.isNil(version) === false) {
    delete version.readme;
  }

  return version;
}

function normalizeContributors(contributors) {
  if (_lodash.default.isNil(contributors)) {
    return [];
  } else if (contributors && _lodash.default.isArray(contributors) === false) {
    // FIXME: this branch is clearly no an array, still tsc complains
    // @ts-ignore
    return [contributors];
  } else if (_lodash.default.isString(contributors)) {
    return [{
      name: contributors
    }];
  }

  return contributors;
}

const WHITELIST = ['_rev', 'name', 'versions', 'dist-tags', 'readme', 'time', '_id', 'users'];
exports.WHITELIST = WHITELIST;

function cleanUpLinksRef(keepUpLinkData, result) {
  const propertyToKeep = [...WHITELIST];

  if (keepUpLinkData === true) {
    propertyToKeep.push('_uplinks');
  }

  for (const i in result) {
    if (propertyToKeep.indexOf(i) === -1) {
      // Remove sections like '_uplinks' from response
      delete result[i];
    }
  }

  return result;
}
/**
 * Check whether a package it is already a local package
 * @param {*} name
 * @param {*} localStorage
 */


function checkPackageLocal(name, localStorage) {
  return new Promise((resolve, reject) => {
    localStorage.getPackageMetadata(name, (err, results) => {
      if (!_lodash.default.isNil(err) && err.status !== _constants.HTTP_STATUS.NOT_FOUND) {
        return reject(err);
      }

      if (results) {
        return reject(_utils.ErrorCode.getConflict(_constants.API_ERROR.PACKAGE_EXIST));
      }

      return resolve();
    });
  });
}

function publishPackage(name, metadata, localStorage) {
  return new Promise((resolve, reject) => {
    localStorage.addPackage(name, metadata, (err, latest) => {
      if (!_lodash.default.isNull(err)) {
        return reject(err);
      } else if (!_lodash.default.isUndefined(latest)) {
        _search.default.add(latest);
      }

      return resolve();
    });
  });
}

function checkPackageRemote(name, isAllowPublishOffline, syncMetadata) {
  return new Promise((resolve, reject) => {
    syncMetadata(name, null, {}, (err, packageJsonLocal, upLinksErrors) => {
      // something weird
      if (err && err.status !== _constants.HTTP_STATUS.NOT_FOUND) {
        return reject(err);
      } // checking package exist already


      if (_lodash.default.isNil(packageJsonLocal) === false) {
        return reject(_utils.ErrorCode.getConflict(_constants.API_ERROR.PACKAGE_EXIST));
      }

      for (let errorItem = 0; errorItem < upLinksErrors.length; errorItem++) {
        // checking error
        // if uplink fails with a status other than 404, we report failure
        if (_lodash.default.isNil(upLinksErrors[errorItem][0]) === false) {
          if (upLinksErrors[errorItem][0].status !== _constants.HTTP_STATUS.NOT_FOUND) {
            if (isAllowPublishOffline) {
              return resolve();
            }

            return reject(_utils.ErrorCode.getServiceUnavailable(_constants.API_ERROR.UPLINK_OFFLINE_PUBLISH));
          }
        }
      }

      return resolve();
    });
  });
}

function mergeUplinkTimeIntoLocal(localMetadata, remoteMetadata) {
  if ('time' in remoteMetadata) {
    return Object.assign({}, localMetadata.time, remoteMetadata.time);
  }

  return localMetadata.time;
}

function prepareSearchPackage(data, time) {
  const listVersions = Object.keys(data.versions);
  const versions = (0, _utils.semverSort)(listVersions);
  const latest = data[_constants.DIST_TAGS] && data[_constants.DIST_TAGS].latest ? data[_constants.DIST_TAGS].latest : versions.pop();

  if (latest && data.versions[latest]) {
    const version = data.versions[latest];
    const versions = {
      [latest]: 'latest'
    };
    const pkg = {
      name: version.name,
      description: version.description,
      [_constants.DIST_TAGS]: {
        latest
      },
      maintainers: version.maintainers || [version.author].filter(Boolean),
      author: version.author,
      repository: version.repository,
      readmeFilename: version.readmeFilename || '',
      homepage: version.homepage,
      keywords: version.keywords,
      bugs: version.bugs,
      license: version.license,
      time: {
        modified: time
      },
      versions
    };
    return pkg;
  }
}
/**
 * Check whether the package metadta has enough data to be published
 * @param pkg metadata
 */


function isPublishablePackage(pkg) {
  const keys = Object.keys(pkg);
  return _lodash.default.includes(keys, 'versions');
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvc3RvcmFnZS11dGlscy50cyJdLCJuYW1lcyI6WyJnZW5lcmF0ZVBhY2thZ2VUZW1wbGF0ZSIsIm5hbWUiLCJ2ZXJzaW9ucyIsInRpbWUiLCJVU0VSUyIsIkRJU1RfVEFHUyIsIl91cGxpbmtzIiwiX2Rpc3RmaWxlcyIsIl9hdHRhY2htZW50cyIsIl9yZXYiLCJub3JtYWxpemVQYWNrYWdlIiwicGtnIiwicGtnUHJvcGVydGllcyIsImZvckVhY2giLCJrZXkiLCJwa2dQcm9wIiwiXyIsImlzTmlsIiwiaXNTdHJpbmciLCJTVE9SQUdFIiwiREVGQVVMVF9SRVZJU0lPTiIsIl9pZCIsImdlbmVyYXRlUmV2aXNpb24iLCJyZXYiLCJzcGxpdCIsImdldExhdGVzdFJlYWRtZSIsImRpc3RUYWdzIiwibGF0ZXN0VmVyc2lvbiIsInJlYWRtZSIsInRyaW0iLCJyZWFkbWVEaXN0VGFnc1ByaW9yaXR5IiwibWFwIiwidGFnIiwidmVyc2lvbiIsImNsZWFuVXBSZWFkbWUiLCJub3JtYWxpemVDb250cmlidXRvcnMiLCJjb250cmlidXRvcnMiLCJpc0FycmF5IiwiV0hJVEVMSVNUIiwiY2xlYW5VcExpbmtzUmVmIiwia2VlcFVwTGlua0RhdGEiLCJyZXN1bHQiLCJwcm9wZXJ0eVRvS2VlcCIsInB1c2giLCJpIiwiaW5kZXhPZiIsImNoZWNrUGFja2FnZUxvY2FsIiwibG9jYWxTdG9yYWdlIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJnZXRQYWNrYWdlTWV0YWRhdGEiLCJlcnIiLCJyZXN1bHRzIiwic3RhdHVzIiwiSFRUUF9TVEFUVVMiLCJOT1RfRk9VTkQiLCJFcnJvckNvZGUiLCJnZXRDb25mbGljdCIsIkFQSV9FUlJPUiIsIlBBQ0tBR0VfRVhJU1QiLCJwdWJsaXNoUGFja2FnZSIsIm1ldGFkYXRhIiwiYWRkUGFja2FnZSIsImxhdGVzdCIsImlzTnVsbCIsImlzVW5kZWZpbmVkIiwiU2VhcmNoIiwiYWRkIiwiY2hlY2tQYWNrYWdlUmVtb3RlIiwiaXNBbGxvd1B1Ymxpc2hPZmZsaW5lIiwic3luY01ldGFkYXRhIiwicGFja2FnZUpzb25Mb2NhbCIsInVwTGlua3NFcnJvcnMiLCJlcnJvckl0ZW0iLCJsZW5ndGgiLCJnZXRTZXJ2aWNlVW5hdmFpbGFibGUiLCJVUExJTktfT0ZGTElORV9QVUJMSVNIIiwibWVyZ2VVcGxpbmtUaW1lSW50b0xvY2FsIiwibG9jYWxNZXRhZGF0YSIsInJlbW90ZU1ldGFkYXRhIiwiT2JqZWN0IiwiYXNzaWduIiwicHJlcGFyZVNlYXJjaFBhY2thZ2UiLCJkYXRhIiwibGlzdFZlcnNpb25zIiwia2V5cyIsInBvcCIsImRlc2NyaXB0aW9uIiwibWFpbnRhaW5lcnMiLCJhdXRob3IiLCJmaWx0ZXIiLCJCb29sZWFuIiwicmVwb3NpdG9yeSIsInJlYWRtZUZpbGVuYW1lIiwiaG9tZXBhZ2UiLCJrZXl3b3JkcyIsImJ1Z3MiLCJsaWNlbnNlIiwibW9kaWZpZWQiLCJpc1B1Ymxpc2hhYmxlUGFja2FnZSIsImluY2x1ZGVzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUlBOzs7O0FBRU8sU0FBU0EsdUJBQVQsQ0FBaUNDLElBQWpDLEVBQXdEO0FBQzdELFNBQU87QUFDTDtBQUNBQSxJQUFBQSxJQUZLO0FBR0xDLElBQUFBLFFBQVEsRUFBRSxFQUhMO0FBSUxDLElBQUFBLElBQUksRUFBRSxFQUpEO0FBS0wsS0FBQ0MsZ0JBQUQsR0FBUyxFQUxKO0FBTUwsS0FBQ0Msb0JBQUQsR0FBYSxFQU5SO0FBT0xDLElBQUFBLFFBQVEsRUFBRSxFQVBMO0FBUUxDLElBQUFBLFVBQVUsRUFBRSxFQVJQO0FBU0xDLElBQUFBLFlBQVksRUFBRSxFQVRUO0FBVUxDLElBQUFBLElBQUksRUFBRTtBQVZELEdBQVA7QUFZRDtBQUVEOzs7Ozs7QUFJTyxTQUFTQyxnQkFBVCxDQUEwQkMsR0FBMUIsRUFBaUQ7QUFDdEQsUUFBTUMsYUFBYSxHQUFHLENBQUMsVUFBRCxFQUFh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LE9BQXhCLENBSnJCO0FBS2ZGLE1BQUFBLE1BQU0sRUFBRXpELE9BQU8sQ0FBQ3lELE1BTEQ7QUFNZkcsTUFBQUEsVUFBVSxFQUFFNUQsT0FBTyxDQUFDNEQsVUFOTDtBQU9mQyxNQUFBQSxjQUFjLEVBQUU3RCxPQUFPLENBQUM2RCxjQUFSLElBQTBCLEVBUDNCO0FBUWZDLE1BQUFBLFFBQVEsRUFBRTlELE9BQU8sQ0FBQzhELFFBUkg7QUFTZkMsTUFBQUEsUUFBUSxFQUFFL0QsT0FBTyxDQUFDK0QsUUFUSDtBQVVmQyxNQUFBQSxJQUFJLEVBQUVoRSxPQUFPLENBQUNnRSxJQVZDO0FBV2ZDLE1BQUFBLE9BQU8sRUFBRWpFLE9BQU8sQ0FBQ2lFLE9BWEY7QUFZZi9GLE1BQUFBLElBQUksRUFBRTtBQUNKZ0csUUFBQUEsUUFBUSxFQUFFaEc7QUFETixPQVpTO0FBZWZELE1BQUFBO0FBZmUsS0FBakI7QUFrQkEsV0FBT1MsR0FBUDtBQUNEO0FBQ0Y7QUFFRDs7Ozs7O0FBSU8sU0FBU3lGLG9CQUFULENBQThCekYsR0FBOUIsRUFBcUQ7QUFDMUQsUUFBTTJFLElBQWMsR0FBR0wsTUFBTSxDQUFDSyxJQUFQLENBQVkzRSxHQUFaLENBQXZCO0FBRUEsU0FBT0ssZ0JBQUVxRixRQUFGLENBQVdmLElBQVgsRUFBaUIsVUFBakIsQ0FBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IEVycm9yQ29kZSwgaXNPYmplY3QsIG5vcm1hbGl6ZURpc3RUYWdzLCBzZW12ZXJTb3J0IH0gZnJvbSAnLi91dGlscyc7XG5pbXBvcnQgU2VhcmNoIGZyb20gJy4vc2VhcmNoJztcbmltcG9ydCB7IGdlbmVyYXRlUmFuZG9tSGV4U3RyaW5nIH0gZnJvbSAnLi4vbGliL2NyeXB0by11dGlscyc7XG5cbmltcG9ydCB7IFBhY2thZ2UsIFZlcnNpb24sIEF1dGhvciB9IGZyb20gJ0B2ZXJkYWNjaW8vdHlwZXMnO1xuaW1wb3J0IHsgSVN0b3JhZ2UgfSBmcm9tICcuLi8uLi90eXBlcyc7XG5pbXBvcnQgeyBBUElfRVJST1IsIEhUVFBfU1RBVFVTLCBESVNUX1RBR1MsIFVTRVJTLCBTVE9SQUdFIH0gZnJvbSAnLi9jb25zdGFudHMnO1xuXG5leHBvcnQgZnVuY3Rpb24gZ2VuZXJhdGVQYWNrYWdlVGVtcGxhdGUobmFtZTogc3RyaW5nKTogUGFja2FnZSB7XG4gIHJldHVybiB7XG4gICAgLy8gc3RhbmRhcmQgdGhpbmdzXG4gICAgbmFtZSxcbiAgICB2ZXJzaW9uczoge30sXG4gICAgdGltZToge30sXG4gICAgW1VTRVJTXToge30sXG4gICAgW0RJU1RfVEFHU106IHt9LFxuICAgIF91cGxpbmtzOiB7fSxcbiAgICBfZGlzdGZpbGVzOiB7fSxcbiAgICBfYXR0YWNobWVudHM6IHt9LFxuICAgIF9yZXY6ICcnLFxuICB9O1xufVxuXG4vKipcbiAqIE5vcm1hbGl6ZSBwYWNrYWdlIHByb3BlcnRpZXMsIHRhZ3MsIHJldmlzaW9uIGlkLlxuICogQHBhcmFtIHtPYmplY3R9IHBrZyBwYWNrYWdlIHJlZmVyZW5jZS5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIG5vcm1hbGl6ZVBhY2thZ2UocGtnOiBQYWNrYWdlKTogUGFja2FnZSB7XG4gIGNvbnN0IHBrZ1Byb3BlcnRpZXMgPSBbJ3ZlcnNpb25zJywgJ2Rpc3QtdGFncycsICdfZGlzdGZpbGVzJywgJ19hdHRhY2htZW50cycsICdfdXBsaW5rcycsICd0aW1lJ107XG5cbiAgcGtnUHJvcGVydGllcy5mb3JFYWNoKFxuICAgIChrZXkpOiB2b2lkID0+IHtcbiAgICAgIGNvbnN0IHBrZ1Byb3AgPSBwa2dba2V5XTtcblxuICAgICAgaWYgKF8uaXNOaWwocGtnUHJvcCkgfHwgaXNPYmplY3QocGtnUHJvcCkgPT09IGZhbHNlKSB7XG4gICAgICAgIHBrZ1trZXldID0ge307XG4gICAgICB9XG4gICAgfVxuICApO1xuXG4gIGlmIChfLmlzU3RyaW5nKHBrZy5fcmV2KSA9PT0gZmFsc2UpIHtcbiAgICBwa2cuX3JldiA9IFNUT1JBR0UuREVGQVVMVF9SRVZJU0lPTjtcbiAgfVxuXG4gIGlmIChfLmlzU3RyaW5nKHBrZy5faWQpID09PSBmYWxzZSkge1xuICAgIHBrZy5faWQgPSBwa2cubmFtZTtcbiAgfVxuXG4gIC8vIG5vcm1hbGl6ZSBkaXN0LXRhZ3NcbiAgbm9ybWFsaXplRGlzdFRhZ3MocGtnKTtcblxuICByZXR1cm4gcGtnO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2VuZXJhdGVSZXZpc2lvbihyZXY6IHN0cmluZyk6IHN0cmluZyB7XG4gIGNvbnN0IF9yZXYgPSByZXYuc3BsaXQoJy0nKTtcblxuICByZXR1cm4gKCtfcmV2WzBdIHx8IDApICsgMSArICctJyArIGdlbmVyYXRlUmFuZG9tSGV4U3RyaW5nKCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRMYXRlc3RSZWFkbWUocGtnOiBQYWNrYWdlKTogc3RyaW5nIHtcbiAgY29uc3QgdmVyc2lvbnMgPSBwa2dbJ3ZlcnNpb25zJ10gfHwge307XG4gIGNvbnN0IGRpc3RUYWdzID0gcGtnW0RJU1RfVEFHU10gfHwge307XG4gIC8vIEZJWE1FOiBoZXJlIGlzIGEgYml0IHRyaWNreSBhZGQgdGhlIHR5cGVzXG4gIGNvbnN0IGxhdGVzdFZlcnNpb246IFZlcnNpb24gfCBhbnkgPSBkaXN0VGFnc1snbGF0ZXN0J10gPyB2ZXJzaW9uc1tkaXN0VGFnc1snbGF0ZXN0J11dIHx8IHt9IDoge307XG4gIGxldCByZWFkbWUgPSBfLnRyaW0ocGtnLnJlYWRtZSB8fCBsYXRlc3RWZXJzaW9uLnJlYWRtZSB8fCAnJyk7XG4gIGlmIChyZWFkbWUpIHtcbiAgICByZXR1cm4gcmVhZG1lO1xuICB9XG5cbiAgLy8gSW4gY2FzZSBvZiBlbXB0eSByZWFkbWUgLSB0cnlpbmcgdG8gZ2V0IEFOWSByZWFkbWUgaW4gdGhlIGZvbGxvd2luZyBvcmRlcjogJ25leHQnLCdiZXRhJywnYWxwaGEnLCd0ZXN0JywnZGV2JywnY2FuYXJ5J1xuICBjb25zdCByZWFkbWVEaXN0VGFnc1ByaW9yaXR5ID0gWyduZXh0JywgJ2JldGEnLCAnYWxwaGEnLCAndGVzdCcsICdkZXYnLCAnY2FuYXJ5J107XG4gIHJlYWRtZURpc3RUYWdzUHJpb3JpdHkubWFwKGZ1bmN0aW9uKHRhZyk6IHN0cmluZyB8IHZvaWQge1xuICAgIGlmIChyZWFkbWUpIHtcbiAgICAgIHJldHVybiByZWFkbWU7XG4gICAgfVxuICAgIGNvbnN0IHZlcnNpb246IFZlcnNpb24gfCBhbnkgPSBkaXN0VGFnc1t0YWddID8gdmVyc2lvbnNbZGlzdFRhZ3NbdGFnXV0gfHwge30gOiB7fTtcbiAgICByZWFkbWUgPSBfLnRyaW0odmVyc2lvbi5yZWFkbWUgfHwgcmVhZG1lKTtcbiAgfSk7XG4gIHJldHVybiByZWFkbWU7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjbGVhblVwUmVhZG1lKHZlcnNpb246IFZlcnNpb24pOiBWZXJzaW9uIHtcbiAgaWYgKF8uaXNOaWwodmVyc2lvbikgPT09IGZhbHNlKSB7XG4gICAgZGVsZXRlIHZlcnNpb24ucmVhZG1lO1xuICB9XG5cbiAgcmV0dXJuIHZlcnNpb247XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBub3JtYWxpemVDb250cmlidXRvcnMoY29udHJpYnV0b3JzOiBBdXRob3JbXSk6IEF1dGhvcltdIHtcbiAgaWYgKF8uaXNOaWwoY29udHJpYnV0b3JzKSkge1xuICAgIHJldHVybiBbXTtcbiAgfSBlbHNlIGlmIChjb250cmlidXRvcnMgJiYgXy5pc0FycmF5KGNvbnRyaWJ1dG9ycykgPT09IGZhbHNlKSB7XG4gICAgLy8gRklYTUU6IHRoaXMgYnJhbmNoIGlzIGNsZWFybHkgbm8gYW4gYXJyYXksIHN0aWxsIHRzYyBjb21wbGFpbnNcbiAgICAvLyBAdHMtaWdub3JlXG4gICAgcmV0dXJuIFtjb250cmlidXRvcnNdO1xuICB9IGVsc2UgaWYgKF8uaXNTdHJpbmcoY29udHJpYnV0b3JzKSkge1xuICAgIHJldHVybiBbXG4gICAgICB7XG4gICAgICAgIG5hbWU6IGNvbnRyaWJ1dG9ycyxcbiAgICAgIH0sXG4gICAgXTtcbiAgfVxuXG4gIHJldHVybiBjb250cmlidXRvcnM7XG59XG5cbmV4cG9ydCBjb25zdCBXSElURUxJU1QgPSBbJ19yZXYnLCAnbmFtZScsICd2ZXJzaW9ucycsICdkaXN0LXRhZ3MnLCAncmVhZG1lJywgJ3RpbWUnLCAnX2lkJywgJ3VzZXJzJ107XG5cbmV4cG9ydCBmdW5jdGlvbiBjbGVhblVwTGlua3NSZWYoa2VlcFVwTGlua0RhdGE6IGJvb2xlYW4sIHJlc3VsdDogUGFja2FnZSk6IFBhY2thZ2Uge1xuICBjb25zdCBwcm9wZXJ0eVRvS2VlcCA9IFsuLi5XSElURUxJU1RdO1xuICBpZiAoa2VlcFVwTGlua0RhdGEgPT09IHRydWUpIHtcbiAgICBwcm9wZXJ0eVRvS2VlcC5wdXNoKCdfdXBsaW5rcycpO1xuICB9XG5cbiAgZm9yIChjb25zdCBpIGluIHJlc3VsdCkge1xuICAgIGlmIChwcm9wZXJ0eVRvS2VlcC5pbmRleE9mKGkpID09PSAtMSkge1xuICAgICAgLy8gUmVtb3ZlIHNlY3Rpb25zIGxpa2UgJ191cGxpbmtzJyBmcm9tIHJlc3BvbnNlXG4gICAgICBkZWxldGUgcmVzdWx0W2ldO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiByZXN1bHQ7XG59XG5cbi8qKlxuICogQ2hlY2sgd2hldGhlciBhIHBhY2thZ2UgaXQgaXMgYWxyZWFkeSBhIGxvY2FsIHBhY2thZ2VcbiAqIEBwYXJhbSB7Kn0gbmFtZVxuICogQHBhcmFtIHsqfSBsb2NhbFN0b3JhZ2VcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNoZWNrUGFja2FnZUxvY2FsKG5hbWU6IHN0cmluZywgbG9jYWxTdG9yYWdlOiBJU3RvcmFnZSk6IFByb21pc2U8YW55PiB7XG4gIHJldHVybiBuZXcgUHJvbWlzZShcbiAgICAocmVzb2x2ZSwgcmVqZWN0KTogdm9pZCA9PiB7XG4gICAgICBsb2NhbFN0b3JhZ2UuZ2V0UGFja2FnZU1ldGFkYXRhKFxuICAgICAgICBuYW1lLFxuICAgICAgICAoZXJyLCByZXN1bHRzKTogdm9pZCA9PiB7XG4gICAgICAgICAgaWYgKCFfLmlzTmlsKGVycikgJiYgZXJyLnN0YXR1cyAhPT0gSFRUUF9TVEFUVVMuTk9UX0ZPVU5EKSB7XG4gICAgICAgICAgICByZXR1cm4gcmVqZWN0KGVycik7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChyZXN1bHRzKSB7XG4gICAgICAgICAgICByZXR1cm4gcmVqZWN0KEVycm9yQ29kZS5nZXRDb25mbGljdChBUElfRVJST1IuUEFDS0FHRV9FWElTVCkpO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gcmVzb2x2ZSgpO1xuICAgICAgICB9XG4gICAgICApO1xuICAgIH1cbiAgKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHB1Ymxpc2hQYWNrYWdlKG5hbWU6IHN0cmluZywgbWV0YWRhdGE6IGFueSwgbG9jYWxTdG9yYWdlOiBJU3RvcmFnZSk6IFByb21pc2U8YW55PiB7XG4gIHJldHVybiBuZXcgUHJvbWlzZShcbiAgICAocmVzb2x2ZSwgcmVqZWN0KTogdm9pZCA9PiB7XG4gICAgICBsb2NhbFN0b3JhZ2UuYWRkUGFja2FnZShcbiAgICAgICAgbmFtZSxcbiAgICAgICAgbWV0YWRhdGEsXG4gICAgICAgIChlcnIsIGxhdGVzdCk6IHZvaWQgPT4ge1xuICAgICAgICAgIGlmICghXy5pc051bGwoZXJyKSkge1xuICAgICAgICAgICAgcmV0dXJuIHJlamVjdChlcnIpO1xuICAgICAgICAgIH0gZWxzZSBpZiAoIV8uaXNVbmRlZmluZWQobGF0ZXN0KSkge1xuICAgICAgICAgICAgU2VhcmNoLmFkZChsYXRlc3QpO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gcmVzb2x2ZSgpO1xuICAgICAgICB9XG4gICAgICApO1xuICAgIH1cbiAgKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNoZWNrUGFja2FnZVJlbW90ZShuYW1lOiBzdHJpbmcsIGlzQWxsb3dQdWJsaXNoT2ZmbGluZTogYm9vbGVhbiwgc3luY01ldGFkYXRhOiBGdW5jdGlvbik6IFByb21pc2U8YW55PiB7XG4gIHJldHVybiBuZXcgUHJvbWlzZShcbiAgICAocmVzb2x2ZSwgcmVqZWN0KTogdm9pZCA9PiB7XG4gICAgICBzeW5jTWV0YWRhdGEoXG4gICAgICAgIG5hbWUsXG4gICAgICAgIG51bGwsXG4gICAgICAgIHt9LFxuICAgICAgICAoZXJyLCBwYWNrYWdlSnNvbkxvY2FsLCB1cExpbmtzRXJyb3JzKTogdm9pZCA9PiB7XG4gICAgICAgICAgLy8gc29tZXRoaW5nIHdlaXJkXG4gICAgICAgICAgaWYgKGVyciAmJiBlcnIuc3RhdHVzICE9PSBIVFRQX1NUQVRVUy5OT1RfRk9VTkQpIHtcbiAgICAgICAgICAgIHJldHVybiByZWplY3QoZXJyKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICAvLyBjaGVja2luZyBwYWNrYWdlIGV4aXN0IGFscmVhZHlcbiAgICAgICAgICBpZiAoXy5pc05pbChwYWNrYWdlSnNvbkxvY2FsKSA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgIHJldHVybiByZWplY3QoRXJyb3JDb2RlLmdldENvbmZsaWN0KEFQSV9FUlJPUi5QQUNLQUdFX0VYSVNUKSk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgZm9yIChsZXQgZXJyb3JJdGVtID0gMDsgZXJyb3JJdGVtIDwgdXBMaW5rc0Vycm9ycy5sZW5ndGg7IGVycm9ySXRlbSsrKSB7XG4gICAgICAgICAgICAvLyBjaGVja2luZyBlcnJvclxuICAgICAgICAgICAgLy8gaWYgdXBsaW5rIGZhaWxzIHdpdGggYSBzdGF0dXMgb3RoZXIgdGhhbiA0MDQsIHdlIHJlcG9ydCBmYWlsdXJlXG4gICAgICAgICAgICBpZiAoXy5pc05pbCh1cExpbmtzRXJyb3JzW2Vycm9ySXRlbV1bMF0pID09PSBmYWxzZSkge1xuICAgICAgICAgICAgICBpZiAodXBMaW5rc0Vycm9yc1tlcnJvckl0ZW1dWzBdLnN0YXR1cyAhPT0gSFRUUF9TVEFUVVMuTk9UX0ZPVU5EKSB7XG4gICAgICAgICAgICAgICAgaWYgKGlzQWxsb3dQdWJsaXNoT2ZmbGluZSkge1xuICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gcmVqZWN0KEVycm9yQ29kZS5nZXRTZXJ2aWNlVW5hdmFpbGFibGUoQVBJX0VSUk9SLlVQTElOS19PRkZMSU5FX1BVQkxJU0gpKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiByZXNvbHZlKCk7XG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfVxuICApO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbWVyZ2VVcGxpbmtUaW1lSW50b0xvY2FsKGxvY2FsTWV0YWRhdGE6IFBhY2thZ2UsIHJlbW90ZU1ldGFkYXRhOiBQYWNrYWdlKTogYW55IHtcbiAgaWYgKCd0aW1lJyBpbiByZW1vdGVNZXRhZGF0YSkge1xuICAgIHJldHVybiBPYmplY3QuYXNzaWduKHt9LCBsb2NhbE1ldGFkYXRhLnRpbWUsIHJlbW90ZU1ldGFkYXRhLnRpbWUpO1xuICB9XG5cbiAgcmV0dXJuIGxvY2FsTWV0YWRhdGEudGltZTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHByZXBhcmVTZWFyY2hQYWNrYWdlKGRhdGE6IFBhY2thZ2UsIHRpbWU6IHVua25vd24pOiBhbnkge1xuICBjb25zdCBsaXN0VmVyc2lvbnM6IHN0cmluZ1tdID0gT2JqZWN0LmtleXMoZGF0YS52ZXJzaW9ucyk7XG4gIGNvbnN0IHZlcnNpb25zOiBzdHJpbmdbXSA9IHNlbXZlclNvcnQobGlzdFZlcnNpb25zKTtcbiAgY29uc3QgbGF0ZXN0OiBzdHJpbmcgfCB1bmRlZmluZWQgPSBkYXRhW0RJU1RfVEFHU10gJiYgZGF0YVtESVNUX1RBR1NdLmxhdGVzdCA/IGRhdGFbRElTVF9UQUdTXS5sYXRlc3QgOiB2ZXJzaW9ucy5wb3AoKTtcblxuICBpZiAobGF0ZXN0ICYmIGRhdGEudmVyc2lvbnNbbGF0ZXN0XSkge1xuICAgIGNvbnN0IHZlcnNpb246IFZlcnNpb24gPSBkYXRhLnZlcnNpb25zW2xhdGVzdF07XG4gICAgY29uc3QgdmVyc2lvbnM6IGFueSA9IHsgW2xhdGVzdF06ICdsYXRlc3QnIH07XG4gICAgY29uc3QgcGtnOiBhbnkgPSB7XG4gICAgICBuYW1lOiB2ZXJzaW9uLm5hbWUsXG4gICAgICBkZXNjcmlwdGlvbjogdmVyc2lvbi5kZXNjcmlwdGlvbixcbiAgICAgIFtESVNUX1RBR1NdOiB7IGxhdGVzdCB9LFxuICAgICAgbWFpbnRhaW5lcnM6IHZlcnNpb24ubWFpbnRhaW5lcnMgfHwgW3ZlcnNpb24uYXV0aG9yXS5maWx0ZXIoQm9vbGVhbiksXG4gICAgICBhdXRob3I6IHZlcnNpb24uYXV0aG9yLFxuICAgICAgcmVwb3NpdG9yeTogdmVyc2lvbi5yZXBvc2l0b3J5LFxuICAgICAgcmVhZG1lRmlsZW5hbWU6IHZlcnNpb24ucmVhZG1lRmlsZW5hbWUgfHwgJycsXG4gICAgICBob21lcGFnZTogdmVyc2lvbi5ob21lcGFnZSxcbiAgICAgIGtleXdvcmRzOiB2ZXJzaW9uLmtleXdvcmRzLFxuICAgICAgYnVnczogdmVyc2lvbi5idWdzLFxuICAgICAgbGljZW5zZTogdmVyc2lvbi5saWNlbnNlLFxuICAgICAgdGltZToge1xuICAgICAgICBtb2RpZmllZDogdGltZSxcbiAgICAgIH0sXG4gICAgICB2ZXJzaW9ucyxcbiAgICB9O1xuXG4gICAgcmV0dXJuIHBrZztcbiAgfVxufVxuXG4vKipcbiAqIENoZWNrIHdoZXRoZXIgdGhlIHBhY2thZ2UgbWV0YWR0YSBoYXMgZW5vdWdoIGRhdGEgdG8gYmUgcHVibGlzaGVkXG4gKiBAcGFyYW0gcGtnIG1ldGFkYXRhXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBpc1B1Ymxpc2hhYmxlUGFja2FnZShwa2c6IFBhY2thZ2UpOiBib29sZWFuIHtcbiAgY29uc3Qga2V5czogc3RyaW5nW10gPSBPYmplY3Qua2V5cyhwa2cpO1xuXG4gIHJldHVybiBfLmluY2x1ZGVzKGtleXMsICd2ZXJzaW9ucycpO1xufVxuIl19