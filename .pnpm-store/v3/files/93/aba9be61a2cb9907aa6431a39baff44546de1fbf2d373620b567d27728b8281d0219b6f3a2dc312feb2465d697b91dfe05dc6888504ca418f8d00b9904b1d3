"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = _default;

var _semver = _interopRequireDefault(require("semver"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function compileTextSearch(textSearch) {
  const personMatch = (person, search) => {
    if (typeof person === 'string') return person.includes(search);
    if (typeof person === 'object') for (const field of Object.values(person)) if (typeof field === 'string' && field.includes(search)) return true;
    return false;
  };

  const matcher = function (q) {
    const match = q.match(/author:(.*)/);
    if (match !== null) return pkg => personMatch(pkg.author, match[1]); // TODO: maintainer, keywords, not/is unstable insecure, boost-exact
    // TODO implement some scoring system for freetext

    return pkg => {
      return ['name', 'displayName', 'description'].map(k => pkg[k]).filter(x => x !== undefined).some(txt => txt.includes(q));
    };
  };

  const textMatchers = (textSearch || '').split(' ').map(matcher);
  return pkg => textMatchers.every(m => m(pkg));
}

function _default(route, auth, storage) {
  route.get('/-/v1/search', (req, res) => {
    // TODO: implement proper result scoring weighted by quality, popularity and maintenance query parameters
    let [text, size, from
    /* , quality, popularity, maintenance */
    ] = ['text', 'size', 'from'
    /* , 'quality', 'popularity', 'maintenance' */
    ].map(k => req.query[k]);
    size = parseInt(size) || 20;
    from = parseInt(from) || 0;
    const isInteresting = compileTextSearch(text);
    const resultStream = storage.search(0, {
      req: {
        query: {
          local: true
        }
      }
    });
    const resultBuf = [];
    let completed = false;

    const sendResponse = () => {
      completed = true;
      resultStream.destroy();
      const final = resultBuf.slice(from, size).map(pkg => {
        return {
          package: pkg,
          flags: {
            unstable: Object.keys(pkg.versions).some(v => _semver.default.satisfies(v, '^1.0.0')) ? undefined : true
          },
          score: {
            final: 1,
            detail: {
              quality: 1,
              popularity: 1,
              maintenance: 0
            }
          },
          searchScore: 100000
        };
      });
      const response = {
        objects: final,
        total: final.length,
        time: new Date().toUTCString()
      };
      res.status(200).json(response);
    };

    resultStream.on('data', pkg => {
      if (!isInteresting(pkg)) return;
      resultBuf.push(pkg);
      if (!completed && resultBuf.length >= size + from) sendResponse();
    });
    resultStream.on('end', () => {
      if (!completed) sendResponse();
    });
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9hcGkvZW5kcG9pbnQvYXBpL3YxL3NlYXJjaC50cyJdLCJuYW1lcyI6WyJjb21waWxlVGV4dFNlYXJjaCIsInRleHRTZWFyY2giLCJwZXJzb25NYXRjaCIsInBlcnNvbiIsInNlYXJjaCIsImluY2x1ZGVzIiwiZmllbGQiLCJPYmplY3QiLCJ2YWx1ZXMiLCJtYXRjaGVyIiwicSIsIm1hdGNoIiwicGtnIiwiYXV0aG9yIiwibWFwIiwiayIsImZpbHRlciIsIngiLCJ1bmRlZmluZWQiLCJzb21lIiwidHh0IiwidGV4dE1hdGNoZXJzIiwic3BsaXQiLCJldmVyeSIsIm0iLCJyb3V0ZSIsImF1dGgiLCJzdG9yYWdlIiwiZ2V0IiwicmVxIiwicmVzIiwidGV4dCIsInNpemUiLCJmcm9tIiwicXVlcnkiLCJwYXJzZUludCIsImlzSW50ZXJlc3RpbmciLCJyZXN1bHRTdHJlYW0iLCJsb2NhbCIsInJlc3VsdEJ1ZiIsImNvbXBsZXRlZCIsInNlbmRSZXNwb25zZSIsImRlc3Ryb3kiLCJmaW5hbCIsInNsaWNlIiwicGFja2FnZSIsImZsYWdzIiwidW5zdGFibGUiLCJrZXlzIiwidmVyc2lvbnMiLCJ2Iiwic2VtdmVyIiwic2F0aXNmaWVzIiwic2NvcmUiLCJkZXRhaWwiLCJxdWFsaXR5IiwicG9wdWxhcml0eSIsIm1haW50ZW5hbmNlIiwic2VhcmNoU2NvcmUiLCJyZXNwb25zZSIsIm9iamVjdHMiLCJ0b3RhbCIsImxlbmd0aCIsInRpbWUiLCJEYXRlIiwidG9VVENTdHJpbmciLCJzdGF0dXMiLCJqc29uIiwib24iLCJwdXNoIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7Ozs7QUFHQSxTQUFTQSxpQkFBVCxDQUEyQkMsVUFBM0IsRUFBNEU7QUFDcEUsUUFBTUMsV0FBVyxHQUFHLENBQUNDLE1BQUQsRUFBU0MsTUFBVCxLQUFvQjtBQUNwQyxRQUFHLE9BQU9ELE1BQVAsS0FBa0IsUUFBckIsRUFDSSxPQUFPQSxNQUFNLENBQUNFLFFB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QUNuQixLQUhEO0FBSUgsR0E3REQ7QUE4REgiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgc2VtdmVyIGZyb20gJ3NlbXZlcidcbmltcG9ydCB7IFBhY2thZ2UgfSBmcm9tICdAdmVyZGFjY2lvL3R5cGVzJztcblxuZnVuY3Rpb24gY29tcGlsZVRleHRTZWFyY2godGV4dFNlYXJjaDogc3RyaW5nKTogKChwa2c6IFBhY2thZ2UpID0+IGJvb2xlYW4pIHtcbiAgICAgICAgY29uc3QgcGVyc29uTWF0Y2ggPSAocGVyc29uLCBzZWFyY2gpID0+IHtcbiAgICAgICAgICAgIGlmKHR5cGVvZiBwZXJzb24gPT09ICdzdHJpbmcnKVxuICAgICAgICAgICAgICAgIHJldHVybiBwZXJzb24uaW5jbHVkZXMoc2VhcmNoKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYodHlwZW9mIHBlcnNvbiA9PT0gJ29iamVjdCcpXG4gICAgICAgICAgICAgICAgZm9yKGNvbnN0IGZpZWxkIG9mIE9iamVjdC52YWx1ZXMocGVyc29uKSlcbiAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mIGZpZWxkID09PSAnc3RyaW5nJyAmJiBmaWVsZC5pbmNsdWRlcyhzZWFyY2gpKVxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBtYXRjaGVyID0gZnVuY3Rpb24ocSkge1xuICAgICAgICAgICAgY29uc3QgbWF0Y2ggPSBxLm1hdGNoKC9hdXRob3I6KC4qKS8pXG4gICAgICAgICAgICBpZihtYXRjaCAhPT0gbnVsbClcbiAgICAgICAgICAgICAgICByZXR1cm4gKHBrZykgPT4gcGVyc29uTWF0Y2gocGtnLmF1dGhvciwgbWF0Y2hbMV0pXG5cbiAgICAgICAgICAgIC8vIFRPRE86IG1haW50YWluZXIsIGtleXdvcmRzLCBub3QvaXMgdW5zdGFibGUgaW5zZWN1cmUsIGJvb3N0LWV4YWN0XG4gICAgICAgICAgICAvLyBUT0RPIGltcGxlbWVudCBzb21lIHNjb3Jpbmcgc3lzdGVtIGZvciBmcmVldGV4dFxuICAgICAgICAgICAgcmV0dXJuIChwa2cpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gWyduYW1lJywgJ2Rpc3BsYXlOYW1lJywgJ2Rlc2NyaXB0aW9uJ11cbiAgICAgICAgICAgICAgICAgICAgLm1hcChrID0+IHBrZ1trXSlcbiAgICAgICAgICAgICAgICAgICAgLmZpbHRlcih4ID0+IHggIT09IHVuZGVmaW5lZClcbiAgICAgICAgICAgICAgICAgICAgLnNvbWUodHh0ID0+IHR4dC5pbmNsdWRlcyhxKSlcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCB0ZXh0TWF0Y2hlcnMgPSAodGV4dFNlYXJjaCB8fCAnJykuc3BsaXQoJyAnKS5tYXAobWF0Y2hlcik7XG4gICAgICAgIHJldHVybiAocGtnKSA9PiB0ZXh0TWF0Y2hlcnMuZXZlcnkobSA9PiBtKHBrZykpO1xufVxuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbihyb3V0ZSwgYXV0aCwgc3RvcmFnZSk6IHZvaWQge1xuICAgIHJvdXRlLmdldCgnLy0vdjEvc2VhcmNoJywgKHJlcSwgcmVzKT0+e1xuICAgICAgICAvLyBUT0RPOiBpbXBsZW1lbnQgcHJvcGVyIHJlc3VsdCBzY29yaW5nIHdlaWdodGVkIGJ5IHF1YWxpdHksIHBvcHVsYXJpdHkgYW5kIG1haW50ZW5hbmNlIHF1ZXJ5IHBhcmFtZXRlcnNcbiAgICAgICAgbGV0IFt0ZXh0LCBzaXplLCBmcm9tIC8qICwgcXVhbGl0eSwgcG9wdWxhcml0eSwgbWFpbnRlbmFuY2UgKi9dID0gXG4gICAgICAgICAgICBbJ3RleHQnLCAnc2l6ZScsICdmcm9tJyAvKiAsICdxdWFsaXR5JywgJ3BvcHVsYXJpdHknLCAnbWFpbnRlbmFuY2UnICovXVxuICAgICAgICAgICAgLm1hcChrID0+IHJlcS5xdWVyeVtrXSlcbiAgICAgICAgXG4gICAgICAgIHNpemUgPSBwYXJzZUludChzaXplKSB8fCAyMDtcbiAgICAgICAgZnJvbSA9IHBhcnNlSW50KGZyb20pIHx8IDA7XG4gICAgICAgIFxuICAgICAgICBjb25zdCBpc0ludGVyZXN0aW5nID0gY29tcGlsZVRleHRTZWFyY2godGV4dCk7XG5cbiAgICAgICAgY29uc3QgcmVzdWx0U3RyZWFtID0gc3RvcmFnZS5zZWFyY2goMCwge3JlcToge3F1ZXJ5OiB7bG9jYWw6IHRydWV9fX0pO1xuICAgICAgICBjb25zdCByZXN1bHRCdWYgPSBbXSBhcyBhbnk7XG4gICAgICAgIGxldCBjb21wbGV0ZWQgPSBmYWxzZTtcblxuICAgICAgICBjb25zdCBzZW5kUmVzcG9uc2UgPSAoKTogdm9pZCA9PiB7XG4gICAgICAgICAgICBjb21wbGV0ZWQgPSB0cnVlO1xuICAgICAgICAgICAgcmVzdWx0U3RyZWFtLmRlc3Ryb3koKVxuXG4gICAgICAgICAgICBjb25zdCBmaW5hbCA9IHJlc3VsdEJ1Zi5zbGljZShmcm9tLCBzaXplKS5tYXAocGtnID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFja2FnZTogcGtnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsYWdzOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVuc3RhYmxlOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgT2JqZWN0LmtleXMocGtnLnZlcnNpb25zKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5zb21lKHYgPT4gc2VtdmVyLnNhdGlzZmllcyh2LCAnXjEuMC4wJykpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gdW5kZWZpbmVkXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogdHJ1ZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcmU6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmluYWw6IDEsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRldGFpbDoge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcXVhbGl0eTogMSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvcHVsYXJpdHk6IDEsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYWludGVuYW5jZTogMFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWFyY2hTY29yZTogMTAwMDAwXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICBjb25zdCByZXNwb25zZSA9IHtcbiAgICAgICAgICAgICAgICAgICAgb2JqZWN0czogZmluYWwsXG4gICAgICAgICAgICAgICAgICAgIHRvdGFsOiBmaW5hbC5sZW5ndGgsXG4gICAgICAgICAgICAgICAgICAgIHRpbWU6IG5ldyBEYXRlKCkudG9VVENTdHJpbmcoKVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmVzLnN0YXR1cygyMDApXG4gICAgICAgICAgICAgICAgLmpzb24ocmVzcG9uc2UpXG4gICAgICAgIH1cblxuICAgICAgICByZXN1bHRTdHJlYW0ub24oJ2RhdGEnLCAocGtnKT0+e1xuICAgICAgICAgICAgaWYoIWlzSW50ZXJlc3RpbmcocGtnKSlcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICByZXN1bHRCdWYucHVzaChwa2cpXG4gICAgICAgICAgICBpZighY29tcGxldGVkICYmIHJlc3VsdEJ1Zi5sZW5ndGggPj0gc2l6ZSArIGZyb20pXG4gICAgICAgICAgICAgICAgc2VuZFJlc3BvbnNlKCk7XG4gICAgICAgIH0pXG4gICAgICAgIHJlc3VsdFN0cmVhbS5vbignZW5kJywgKCk9PntcbiAgICAgICAgICAgIGlmKCFjb21wbGV0ZWQpXG4gICAgICAgICAgICAgICAgc2VuZFJlc3BvbnNlKClcbiAgICAgICAgfSlcbiAgICB9KVxufSJdfQ==